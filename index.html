<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Lumen">
<meta name="theme-color" content="#2563eb">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>Lumen</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Lato:wght@300;400;700&family=Lexend:wght@300;400;500;600;700&family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --paper: #faf8f4;
  --ink: #1a1714;
  --ink-light: #6b6560;
  --ink-faint: #b0a898;
  --line: #e0d8cc;
  --radius: 14px;
  --shadow: 0 2px 16px rgba(0,0,0,0.07), 0 1px 3px rgba(0,0,0,0.05);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
  --blue:   #2563eb; --blue-bg:   #eff6ff;
  --green:  #16a34a; --green-bg:  #f0fdf4;
  --orange: #ea580c; --orange-bg: #fff7ed;
  --violet: #7c3aed; --violet-bg: #f5f3ff;
  --mod: var(--blue);
  --mod-bg: var(--blue-bg);
}

html, body { height: 100%; }
body {
  font-family: Georgia, 'Times New Roman', serif;
  background: linear-gradient(to bottom, #eef7fd, #d5eaf6);
  background-attachment: fixed;
  color: var(--ink);
  overflow: hidden;
}

/* â”€â”€ WORD CANVAS â”€â”€ */
#wc { position: fixed; inset: 0; pointer-events: none; z-index: 1; }

/* â”€â”€ SCREENS â”€â”€ */
.screen {
  position: fixed; inset: 0; z-index: 10;
  display: flex; flex-direction: column;
  background: transparent; overflow-y: auto;
  transition: opacity 0.3s ease, transform 0.3s ease;
}
.screen.hidden { opacity: 0; pointer-events: none; transform: translateX(24px); }
.screen.slide-back { transform: translateX(-24px); }

/* â”€â”€ BUBBLE â”€â”€ */
.bubble-wrap { position: relative; display: inline-block; }
.bubble {
  position: absolute;
  bottom: calc(100% + 10px); left: 50%;
  transform: translateX(-50%) translateY(4px);
  background: var(--ink); color: var(--paper);
  padding: 6px 12px; border-radius: 10px;
  font-size: 0.78rem; font-style: italic;
  white-space: nowrap; pointer-events: none;
  opacity: 0; transition: opacity 0.2s, transform 0.2s; z-index: 200;
}
.bubble::after {
  content: ''; position: absolute;
  top: 100%; left: 50%; transform: translateX(-50%);
  border: 5px solid transparent; border-top-color: var(--ink);
}
.bubble.show { opacity: 1; transform: translateX(-50%) translateY(0); }
.pen-sm-wrap .bubble { bottom: auto; top: calc(100% + 10px); }
.pen-sm-wrap .bubble::after { top: auto; bottom: 100%; border-top-color: transparent; border-bottom-color: var(--ink); }

/* â”€â”€ PEN â”€â”€ */
.pen { display: inline-block; cursor: pointer; filter: drop-shadow(0 3px 8px rgba(0,0,0,0.18)); }
.pen:active { transform: scale(0.93) rotate(-5deg); }
.pen svg { display: block; }
.pen-lg svg { width: 80px; height: 80px; }
.pen-sm svg { width: 40px; height: 40px; }

/* â•â• METALLIC TEXT â•â• */
.metallic-text {
  font-family: 'Cinzel', Georgia, serif;
  background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #172554 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  filter: drop-shadow(0 2px 4px rgba(59,130,246,0.2));
}

/* â”€â”€ Float animation â”€â”€ */
@keyframes float {
  0%, 100% { transform: translateY(0) rotate(0deg); }
  50%       { transform: translateY(-15px) rotate(2deg); }
}
.float-anim { animation: float 6s ease-in-out infinite; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SPLASH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#splash { align-items: center; justify-content: center; text-align: center; padding: 2rem; }

.splash-logo {
  font-family: 'Cinzel', Georgia, serif;
  font-size: clamp(3rem, 14vw, 5.5rem);
  font-weight: 700; letter-spacing: 0.15em;
  margin-top: 1.5rem;
  animation: fadeUp 0.6s 0.3s ease both;
}
.splash-sub {
  font-family: 'Lato', sans-serif;
  font-style: normal; color: #4a6fa5;
  font-size: 0.8rem; margin-top: 0.5rem;
  letter-spacing: 0.3em; text-transform: uppercase;
  animation: fadeUp 0.6s 0.6s ease both;
}
.splash-phrase {
  font-style: italic; color: var(--ink-light);
  font-size: 0.9rem; margin-top: 2rem; min-height: 1.4rem;
  animation: fadeUp 0.5s 1s ease both; transition: opacity 0.3s;
}
.dots span { display: inline-block; animation: dot 1.2s ease infinite; }
.dots span:nth-child(2) { animation-delay: 0.2s; }
.dots span:nth-child(3) { animation-delay: 0.4s; }
@keyframes dot {
  0%,80%,100% { opacity: 0.2; transform: scale(0.7); }
  40% { opacity: 1; transform: scale(1); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HOME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#home { padding: 0; overflow-y: auto; }

.home-head {
  padding: 2.8rem 1.5rem 1rem;
  display: flex; flex-direction: column;
  align-items: center; text-align: center;
}
.home-logo {
  font-family: 'Cinzel', Georgia, serif;
  font-size: clamp(2.5rem, 10vw, 4rem);
  font-weight: 700; letter-spacing: 0.12em;
}
.home-tag {
  font-family: 'Lato', sans-serif;
  font-style: normal; color: #4a6fa5;
  font-size: 0.72rem; margin-top: 0.45rem;
  letter-spacing: 0.3em; text-transform: uppercase;
}

/* Cards */
.grid {
  display: grid; grid-template-columns: 1fr 1fr;
  gap: 1rem; padding: 1rem 1.1rem;
  max-width: 560px; margin: 0 auto; width: 100%;
}
.card {
  background: rgba(255,255,255,0.92); border-radius: 1rem;
  padding: 1.2rem; cursor: pointer;
  height: 9rem;
  display: flex; flex-direction: column; justify-content: space-between;
  box-shadow: 0 20px 25px -5px rgba(0,0,0,0.08), 0 10px 10px -5px rgba(0,0,0,0.03);
  border: 2px solid var(--c);
  transition: transform 0.18s, box-shadow 0.18s;
  -webkit-tap-highlight-color: transparent;
  backdrop-filter: blur(8px);
}
.card:hover  { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
.card:active { transform: scale(0.97); }
.card[data-m="simplificar"] { --c: #0ea5e9; }
.card[data-m="burocracia"]  { --c: #ef4444; }
.card[data-m="apuntes"]     { --c: #22c55e; }
.card[data-m="revision"]    { --c: #a855f7; }
.card-icon {
  width: 2.4rem; height: 2.4rem; border-radius: 0.6rem;
  background: color-mix(in srgb, var(--c) 13%, transparent);
  color: var(--c);
  display: flex; align-items: center; justify-content: center;
}
.card-icon .material-symbols-outlined { font-size: 1.4rem; }
.card-name {
  font-family: 'Cinzel', Georgia, serif;
  font-size: 0.95rem; font-weight: 700;
  color: var(--ink); letter-spacing: 0.05em;
}
.card-desc {
  font-family: 'Lato', sans-serif;
  font-size: 0.58rem; color: var(--ink-light);
  margin-top: 0.2rem; text-transform: uppercase; letter-spacing: 0.1em;
}

/* Bottom feathers */
.feathers-wrapper {
  position: relative; height: 160px; width: 100%;
  overflow: hidden;
  display: flex; justify-content: center; align-items: flex-end;
  pointer-events: none; margin-top: auto;
}
.feather-float {
  position: absolute; bottom: 0;
  filter: drop-shadow(4px 8px 12px rgba(0,0,0,0.2));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODULE SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#mod { padding-bottom: 3rem; transition: background-color 0.3s; }
#mod[data-mod="simplificar"] { background-color: #f8fafc; }
#mod[data-mod="burocracia"]  { background-color: #f8fafb; }
#mod[data-mod="apuntes"]     { background-color: #fdf8f8; }
#mod[data-mod="revision"]    { background-color: #ede9fe; }

.mod-head {
  display: flex; align-items: center; gap: 0.6rem;
  padding: 1rem 1rem 0.8rem;
  position: sticky; top: 0;
  background: rgba(238,247,253,0.93);
  backdrop-filter: blur(10px);
  border-bottom: 1px solid rgba(186,230,253,0.4);
  z-index: 50;
}
#mod[data-mod="apuntes"]  .mod-head { background: rgba(253,248,248,0.93); border-bottom-color: rgba(252,165,165,0.3); }
#mod[data-mod="revision"] .mod-head { background: rgba(237,233,254,0.93); border-bottom-color: rgba(196,181,253,0.3); }

.btn-back {
  background: none; border: none; cursor: pointer;
  color: var(--ink-light); padding: 6px; border-radius: 8px;
  display: flex; transition: color 0.15s, background 0.15s;
  -webkit-tap-highlight-color: transparent;
  flex-shrink: 0; font-size: 1.3rem; line-height: 1;
}
.btn-back:hover { color: var(--ink); background: var(--line); }
.mod-title-wrap { flex: 1; }
.mod-title { font-size: 1.2rem; font-weight: normal; color: var(--ink); }
.mod-sub   { font-size: 0.72rem; color: var(--ink-faint); font-style: italic; }
.pen-sm-wrap { position: relative; }
.mod-body  { padding: 1.1rem; max-width: 640px; margin: 0 auto; width: 100%; }

/* â”€â”€ Tabs â”€â”€ */
.tabs { display: flex; background: transparent; gap: 0.5rem; margin-bottom: 1.1rem; }
.tab {
  flex: 1; background: white; border: 1.5px solid #e2e8f0; cursor: pointer;
  padding: 0.65rem 0.2rem; border-radius: 999px;
  font-family: 'Lexend', sans-serif; font-size: 0.6rem;
  color: var(--ink-light);
  display: flex; flex-direction: column; align-items: center; gap: 4px;
  transition: all 0.18s; -webkit-tap-highlight-color: transparent;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
.tab .material-symbols-outlined { font-size: 1.3rem; line-height: 1; }
.tab.on { background: var(--mod); color: white; border-color: var(--mod); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
.tab:hover:not(.on) { border-color: var(--mod); color: var(--ink); }

/* Per-module tab shapes */
#mod[data-mod="revision"] .tab { border-radius: 0.75rem; }

/* Per-module tab icons */
.tab-icon-buro, .tab-icon-other { display: none; }
.tab-text-other { display: none; }
#mod[data-mod="burocracia"] .tab-icon-default { display: none; }
#mod[data-mod="burocracia"] .tab-icon-buro    { display: inline; }
#mod[data-mod="apuntes"]    .tab-icon-default { display: none; }
#mod[data-mod="apuntes"]    .tab-icon-other   { display: inline; }
#mod[data-mod="revision"]   .tab-icon-default { display: none; }
#mod[data-mod="revision"]   .tab-icon-other   { display: inline; }
#mod[data-mod="burocracia"] .tab-text-default { display: none; }
#mod[data-mod="burocracia"] .tab-text-other   { display: inline; }
#mod[data-mod="apuntes"]    .tab-text-default { display: none; }
#mod[data-mod="apuntes"]    .tab-text-other   { display: inline; }
#mod[data-mod="revision"]   .tab-text-default { display: none; }
#mod[data-mod="revision"]   .tab-text-other   { display: inline; }

/* â”€â”€ Panels â”€â”€ */
.panel { display: none; }
.panel.on { display: block; }

.drop {
  border: 2px dashed var(--line); border-radius: var(--radius);
  padding: 2.2rem 1rem; text-align: center;
  cursor: pointer; background: white;
  transition: border-color 0.2s, background 0.2s;
}
.drop:hover, .drop.over { border-color: var(--mod); background: var(--mod-bg); }
.drop input { display: none; }
.drop-icon { font-size: 2rem; opacity: 0.35; margin-bottom: 0.4rem; }
.drop p { font-size: 0.82rem; color: var(--ink-light); font-style: italic; }
.drop small { font-size: 0.72rem; color: var(--ink-faint); }

/* â”€â”€ Text panel chrome â”€â”€ */
.buro-chrome {
  display: none; align-items: center; gap: 0.5rem;
  background: #f8fafb; border: 1.5px solid #e2e8f0;
  border-radius: var(--radius) var(--radius) 0 0;
  padding: 0.5rem 0.8rem; border-bottom: none;
}
#mod[data-mod="burocracia"] .buro-chrome { display: flex; }
.buro-chrome-dot   { width: 7px; height: 7px; border-radius: 50%; background: #10b981; }
.buro-chrome-label { font-size: 0.6rem; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: #10b981; }
.buro-chrome-date  { margin-left: auto; font-size: 0.65rem; color: var(--ink-faint); }

.rev-chrome {
  display: none; align-items: center; gap: 0.5rem;
  background: #f8f5ff; border: 1.5px solid #e9d5ff;
  border-radius: var(--radius) var(--radius) 0 0;
  padding: 0.5rem 0.8rem; border-bottom: none;
}
#mod[data-mod="revision"] .rev-chrome { display: flex; }
.mac-dots { display: flex; gap: 5px; }
.mac-dot  { width: 10px; height: 10px; border-radius: 50%; }
.mac-dot.red   { background: #fc6b68; }
.mac-dot.amber { background: #fdbd41; }
.mac-dot.green { background: #33ca50; }
.rev-mode-label { margin-left: auto; font-size: 0.6rem; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: #a78bfa; }

/* â”€â”€ Textarea wrapper â”€â”€ */
.ta-wrap { position: relative; }
.buro-chrome + .ta-wrap textarea.lta,
.rev-chrome  + .ta-wrap textarea.lta {
  border-top-left-radius: 0; border-top-right-radius: 0; border-top: none;
}

textarea.lta {
  width: 100%; border: 1.5px solid var(--line);
  border-radius: var(--radius); padding: 0.9rem;
  font-family: Georgia, serif; font-size: 0.95rem;
  color: var(--ink); background: white;
  resize: vertical; min-height: 160px;
  outline: none; line-height: 1.7; transition: border-color 0.2s;
}
textarea.lta:focus { border-color: var(--mod); }

/* Per-module notebook lines */
#mod[data-mod="simplificar"] textarea.lta {
  background-image: repeating-linear-gradient(transparent, transparent 31px, #bfdbfe 31px, #bfdbfe 32px);
  background-attachment: local; line-height: 32px; padding-top: 8px; min-height: 200px;
}
#mod[data-mod="burocracia"] .ta-wrap::before {
  content: ''; position: absolute;
  left: 38px; top: 0; bottom: 0; width: 1.5px;
  background: rgba(252,165,165,0.65); z-index: 1; pointer-events: none;
}
#mod[data-mod="burocracia"] textarea.lta {
  background-image: repeating-linear-gradient(transparent, transparent 31px, #e2e8f0 31px, #e2e8f0 32px);
  background-attachment: local; line-height: 32px;
  padding-top: 8px; padding-left: 2.8rem; min-height: 200px;
}
#mod[data-mod="apuntes"] textarea.lta {
  background-image: repeating-linear-gradient(transparent, transparent 31px, #ffcccb 31px, #ffcccb 32px);
  background-attachment: local; line-height: 32px; padding-top: 8px; min-height: 200px;
}
#mod[data-mod="revision"] textarea.lta {
  background: white; border-color: #e9d5ff; min-height: 200px;
}
#mod[data-mod="revision"] textarea.lta:focus { border-color: #a78bfa; }

/* Paste button (RevisiÃ³n) */
.rev-paste-btn {
  display: none; position: absolute; bottom: 0.7rem; right: 0.7rem;
  width: 2.5rem; height: 2.5rem; border-radius: 50%;
  background: white; border: 1px solid #e9d5ff;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  cursor: pointer; color: #a78bfa;
  align-items: center; justify-content: center;
  transition: color 0.15s; -webkit-tap-highlight-color: transparent;
}
.rev-paste-btn .material-symbols-outlined { font-size: 1.2rem; }
.rev-paste-btn:hover { color: #7c3aed; }
#mod[data-mod="revision"] .rev-paste-btn { display: flex; }

/* Status bar (Simplificar) */
.simp-status {
  display: none; align-items: center; gap: 0.4rem;
  margin-top: 0.5rem;
  font-family: 'Lexend', sans-serif; font-size: 0.75rem; color: var(--ink-light);
}
.simp-status .status-dot {
  width: 6px; height: 6px; border-radius: 50%;
  background: #10b981; animation: statusPulse 2s ease infinite;
}
@keyframes statusPulse { 0%,100% { opacity:1; } 50% { opacity:0.4; } }
#mod[data-mod="simplificar"] .simp-status { display: flex; }

.chip {
  display: inline-flex; align-items: center; gap: 0.4rem;
  background: var(--mod-bg);
  border: 1px solid color-mix(in srgb, var(--mod) 30%, transparent);
  color: var(--mod); border-radius: 20px;
  padding: 0.3rem 0.7rem; font-size: 0.78rem; margin-top: 0.6rem;
}
.chip button {
  background: none; border: none; cursor: pointer;
  color: var(--mod); display: flex; padding: 0; font-size: 1rem; line-height: 1;
}

/* Audio */
.audio-box { background: white; border-radius: var(--radius); padding: 1.5rem; text-align: center; box-shadow: var(--shadow); }
.rec-btn {
  width: 68px; height: 68px; border-radius: 50%; border: none;
  background: var(--mod); color: white; cursor: pointer;
  display: inline-flex; align-items: center; justify-content: center;
  font-size: 1.6rem;
  transition: transform 0.2s, box-shadow 0.2s;
  box-shadow: 0 4px 18px color-mix(in srgb, var(--mod) 35%, transparent);
  margin-bottom: 0.6rem;
}
.rec-btn:hover { transform: scale(1.06); }
.rec-btn.on { background: #dc2626; animation: pulse 1.2s ease infinite; box-shadow: 0 4px 18px rgba(220,38,38,0.4); }
@keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.07); } }
.rec-lbl   { font-size: 0.8rem; color: var(--ink-light); font-style: italic; }
.rec-timer { font-size: 1.2rem; color: var(--ink); margin: 0.3rem 0; display: none; }
.audio-prev { margin-top: 0.9rem; display: none; }
.audio-prev audio { width: 100%; }
.audio-file-drop { margin-top: 0.9rem; }
.audio-file-drop .drop { padding: 1.2rem; }

/* Extras */
.field-lbl { font-size: 0.72rem; letter-spacing: 0.05em; text-transform: uppercase; color: var(--ink-light); margin-bottom: 0.35rem; display: block; }
.ctx-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.45rem; margin-bottom: 1rem; }
.ctx-btn {
  border: 1.5px solid var(--line); background: white; border-radius: 10px;
  padding: 0.55rem 0.4rem; cursor: pointer;
  font-family: Georgia, serif; font-size: 0.8rem; color: var(--ink-light);
  display: flex; align-items: center; gap: 0.35rem; justify-content: center;
  transition: all 0.18s; -webkit-tap-highlight-color: transparent;
}
.ctx-btn.on { border-color: var(--mod); background: var(--mod-bg); color: var(--mod); }

/* Submit */
.btn-go {
  width: 100%; background: var(--mod); color: white;
  border: none; border-radius: 999px;
  padding: 0.95rem; font-family: 'Lexend', sans-serif;
  font-size: 1rem; cursor: pointer;
  display: flex; align-items: center; justify-content: center; gap: 0.5rem;
  margin-top: 1.1rem;
  transition: transform 0.15s, box-shadow 0.15s, opacity 0.15s;
  box-shadow: 0 4px 14px color-mix(in srgb, var(--mod) 30%, transparent);
  -webkit-tap-highlight-color: transparent;
}
.btn-go:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 22px color-mix(in srgb, var(--mod) 40%, transparent); }
.btn-go:disabled { opacity: 0.55; cursor: not-allowed; transform: none; }

/* Error */
.err { background: #fef2f2; border: 1.5px solid #fca5a5; border-radius: var(--radius); padding: 0.9rem 1.1rem; color: #991b1b; font-size: 0.85rem; display: none; margin-top: 0.9rem; }
.err.on { display: block; }

/* Loading */
.loading { display: none; flex-direction: column; align-items: center; justify-content: center; padding: 2.5rem 1rem; text-align: center; }
.loading.on { display: flex; }
.ld-pen { animation: bob 0.65s ease infinite alternate; }
@keyframes bob { from { transform: translateY(0) rotate(-4deg); } to { transform: translateY(-14px) rotate(4deg); } }
.ld-phrase { font-style: italic; font-size: 0.95rem; color: var(--ink-light); margin-top: 1.2rem; min-height: 1.4rem; transition: opacity 0.35s; }
.ld-dots { display: flex; gap: 5px; margin-top: 0.6rem; justify-content: center; }
.ld-dots span { width: 6px; height: 6px; border-radius: 50%; background: var(--mod); animation: dot 1.2s ease infinite; }
.ld-dots span:nth-child(2) { animation-delay: 0.2s; }
.ld-dots span:nth-child(3) { animation-delay: 0.4s; }

/* Results */
.results { display: none; margin-top: 1.3rem; }
.results.on { display: block; animation: fadeUp 0.4s ease; }
.res-card { background: white; border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; margin-bottom: 0.9rem; }
.res-head { padding: 0.8rem 1.1rem; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--line); }
.res-label { font-size: 0.72rem; letter-spacing: 0.06em; text-transform: uppercase; color: var(--ink-light); display: flex; align-items: center; gap: 0.35rem; }
.res-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--mod); }
.res-body { padding: 1.1rem; font-size: 0.92rem; line-height: 1.75; color: var(--ink); white-space: pre-wrap; word-break: break-word; }
.btn-copy { background: none; border: none; cursor: pointer; color: var(--ink-faint); padding: 4px; border-radius: 6px; font-size: 0.85rem; display: flex; transition: color 0.15s, background 0.15s; }
.btn-copy:hover { color: var(--ink); background: var(--line); }

/* Simplificar version toggle */
.vtoggle { display: flex; background: var(--line); border-radius: 10px; padding: 3px; gap: 2px; margin-bottom: 0.9rem; }
.vbtn { flex: 1; background: none; border: none; cursor: pointer; padding: 0.5rem; border-radius: 8px; font-family: Georgia, serif; font-size: 0.85rem; color: var(--ink-light); transition: all 0.18s; }
.vbtn.on { background: white; color: var(--mod); box-shadow: 0 1px 4px rgba(0,0,0,0.1); }

/* Burocracia 3 cols */
.buro-cols { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1px; background: var(--line); border-radius: var(--radius); overflow: hidden; margin-bottom: 0.9rem; }
@media (max-width: 420px) { .buro-cols { grid-template-columns: 1fr; } }
.bcol { background: white; padding: 0.9rem; }
.bcol-t { font-size: 0.68rem; letter-spacing: 0.07em; text-transform: uppercase; color: var(--mod); margin-bottom: 0.5rem; }
.bcol-b { font-size: 0.82rem; line-height: 1.65; color: var(--ink); white-space: pre-wrap; }

.rd-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.7rem; margin-bottom: 0.9rem; }
@media (max-width: 380px) { .rd-grid { grid-template-columns: 1fr; } }
.rd-card { background: white; border-radius: var(--radius); padding: 0.9rem; box-shadow: var(--shadow); }
.rd-card.r { border-top: 3px solid var(--green); }
.rd-card.d { border-top: 3px solid var(--orange); }
.rd-t { font-size: 0.68rem; letter-spacing: 0.07em; text-transform: uppercase; margin-bottom: 0.45rem; }
.rd-card.r .rd-t { color: var(--green); }
.rd-card.d .rd-t { color: var(--orange); }
.rd-b { font-size: 0.8rem; line-height: 1.6; color: var(--ink); white-space: pre-wrap; }

/* Save */
.btn-save { display: flex; align-items: center; gap: 0.4rem; background: none; border: 1.5px solid var(--line); border-radius: 10px; padding: 0.5rem 0.9rem; font-family: Georgia, serif; font-size: 0.8rem; color: var(--ink-light); cursor: pointer; transition: all 0.18s; margin: 0.5rem auto 0; width: fit-content; }
.btn-save:hover { border-color: var(--mod); color: var(--mod); }

@keyframes fadeUp { from { opacity: 0; transform: translateY(18px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>

<canvas id="wc"></canvas>

<!-- â•â• SPLASH â•â• -->
<div id="splash" class="screen">
  <div style="margin:auto;text-align:center;padding:2rem;">
    <div class="bubble-wrap" style="display:inline-block;">
      <div class="bubble" id="sb"></div>
      <div class="pen pen-lg float-anim" id="sp" onclick="penClick('sp','sb')">
        <svg viewBox="0 0 200 270" fill="none" style="width:150px;height:200px;display:block;">
          <defs>
            <linearGradient id="sfg" x1="20%" y1="0%" x2="80%" y2="100%">
              <stop offset="0%"   stop-color="#bae6fd"/>
              <stop offset="20%"  stop-color="#7dd3fc"/>
              <stop offset="50%"  stop-color="#0ea5e9"/>
              <stop offset="80%"  stop-color="#0284c7"/>
              <stop offset="100%" stop-color="#0c4a6e"/>
            </linearGradient>
            <linearGradient id="ssp" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%"   stop-color="rgba(240,249,255,0.95)"/>
              <stop offset="100%" stop-color="rgba(125,211,252,0.7)"/>
            </linearGradient>
          </defs>
          <g id="spb">
            <path d="M100 18 C130 18 163 50 166 96 C169 140 152 182 127 215 L100 244 L73 215 C48 182 31 140 34 96 C37 50 70 18 100 18 Z" fill="url(#sfg)" filter="drop-shadow(0 10px 16px rgba(14,165,233,0.4))"/>
            <path d="M97 45 C80 53 62 58 45 59"   stroke="rgba(255,255,255,0.32)" stroke-width="1.4" stroke-linecap="round"/>
            <path d="M94 72 C77 79 59 83 43 83"   stroke="rgba(255,255,255,0.27)" stroke-width="1.4" stroke-linecap="round"/>
            <path d="M92 99 C75 105 57 109 41 109" stroke="rgba(255,255,255,0.22)" stroke-width="1.4" stroke-linecap="round"/>
            <path d="M91 126 C75 131 58 134 43 133" stroke="rgba(255,255,255,0.19)" stroke-width="1.4" stroke-linecap="round"/>
            <path d="M92 153 C77 157 63 159 50 158" stroke="rgba(255,255,255,0.16)" stroke-width="1.4" stroke-linecap="round"/>
            <path d="M103 45 C120 53 138 58 155 59"  stroke="rgba(255,255,255,0.32)" stroke-width="1.4" stroke-linecap="round"/>
            <path d="M106 72 C123 79 141 83 157 83"  stroke="rgba(255,255,255,0.27)" stroke-width="1.4" stroke-linecap="round"/>
            <path d="M108 99 C125 105 143 109 159 109" stroke="rgba(255,255,255,0.22)" stroke-width="1.4" stroke-linecap="round"/>
            <path d="M109 126 C125 131 142 134 157 133" stroke="rgba(255,255,255,0.19)" stroke-width="1.4" stroke-linecap="round"/>
            <path d="M108 153 C123 157 137 159 150 158" stroke="rgba(255,255,255,0.16)" stroke-width="1.4" stroke-linecap="round"/>
            <path d="M100 20 Q101 132 100 242" stroke="url(#ssp)" stroke-width="1.9" stroke-linecap="round"/>
            <line x1="100" y1="244" x2="100" y2="260" stroke="#64748b" stroke-width="2.5" stroke-linecap="round"/>
            <path d="M96 257 L100 268 L104 257" fill="#475569"/>
          </g>
        </svg>
      </div>
    </div>
    <div class="splash-logo metallic-text">LUMEN</div>
    <div class="splash-sub">text assistant</div>
    <div class="splash-phrase" id="sph">Preparando <span class="dots"><span>.</span><span>.</span><span>.</span></span></div>
  </div>
</div>

<!-- â•â• HOME â•â• -->
<div id="home" class="screen hidden">
  <div class="home-head">
    <div class="home-logo metallic-text">LUMEN</div>
    <div class="home-tag">text assistant</div>
  </div>

  <div class="grid">
    <div class="card" data-m="simplificar" onclick="openMod('simplificar')">
      <div class="card-icon"><span class="material-symbols-outlined">auto_fix_high</span></div>
      <div>
        <div class="card-name">Simplificar</div>
        <div class="card-desc">Make concise</div>
      </div>
    </div>
    <div class="card" data-m="burocracia" onclick="openMod('burocracia')">
      <div class="card-icon"><span class="material-symbols-outlined">gavel</span></div>
      <div>
        <div class="card-name">Burocracia</div>
        <div class="card-desc">Formalize</div>
      </div>
    </div>
    <div class="card" data-m="apuntes" onclick="openMod('apuntes')">
      <div class="card-icon"><span class="material-symbols-outlined">edit_note</span></div>
      <div>
        <div class="card-name">Apuntes</div>
        <div class="card-desc">Take notes</div>
      </div>
    </div>
    <div class="card" data-m="revision" onclick="openMod('revision')">
      <div class="card-icon"><span class="material-symbols-outlined">spellcheck</span></div>
      <div>
        <div class="card-name">RevisiÃ³n</div>
        <div class="card-desc">Review</div>
      </div>
    </div>
  </div>

  <!-- Decorative feathers (from PAGINA1) -->
  <div class="feathers-wrapper">
    <svg style="position:absolute;height:0;width:0;overflow:hidden;">
      <defs>
        <linearGradient id="fgBlue" x1="0%" x2="100%" y1="0%" y2="100%">
          <stop offset="0%"   style="stop-color:#bae6fd"/>
          <stop offset="20%"  style="stop-color:#0ea5e9"/>
          <stop offset="50%"  style="stop-color:#0284c7"/>
          <stop offset="100%" style="stop-color:#0c4a6e"/>
        </linearGradient>
        <linearGradient id="fgGreen" x1="0%" x2="100%" y1="0%" y2="100%">
          <stop offset="0%"   style="stop-color:#bbf7d0"/>
          <stop offset="20%"  style="stop-color:#22c55e"/>
          <stop offset="50%"  style="stop-color:#16a34a"/>
          <stop offset="100%" style="stop-color:#14532d"/>
        </linearGradient>
        <linearGradient id="fgRed" x1="0%" x2="100%" y1="0%" y2="100%">
          <stop offset="0%"   style="stop-color:#fecaca"/>
          <stop offset="20%"  style="stop-color:#ef4444"/>
          <stop offset="50%"  style="stop-color:#dc2626"/>
          <stop offset="100%" style="stop-color:#7f1d1d"/>
        </linearGradient>
        <linearGradient id="fgPurple" x1="0%" x2="100%" y1="0%" y2="100%">
          <stop offset="0%"   style="stop-color:#e9d5ff"/>
          <stop offset="20%"  style="stop-color:#a855f7"/>
          <stop offset="50%"  style="stop-color:#9333ea"/>
          <stop offset="100%" style="stop-color:#581c87"/>
        </linearGradient>
        <linearGradient id="fgSpine" x1="0%" x2="0%" y1="0%" y2="100%">
          <stop offset="0%"   style="stop-color:rgba(255,255,255,0.9)"/>
          <stop offset="100%" style="stop-color:rgba(255,255,255,0.4)"/>
        </linearGradient>
        <filter id="fShadow">
          <feDropShadow dx="1" dy="4" stdDeviation="6" flood-color="rgba(0,0,0,0.2)"/>
        </filter>
      </defs>
    </svg>

    <!-- Green feather - far left -->
    <div class="feather-float" style="left:-15px;transform:rotate(-18deg) translateY(25px) scale(0.62);">
      <svg width="200" height="200" viewBox="0 0 512 512" fill="none">
        <path d="M256 50 C316 50 370 110 374 210 C378 310 352 390 314 440 L256 476 L198 440 C160 390 134 310 138 210 C142 110 196 50 256 50 Z" fill="url(#fgGreen)" filter="url(#fShadow)"/>
        <path d="M252 108 C225 120 196 128 168 130" stroke="rgba(255,255,255,0.28)" stroke-width="3" stroke-linecap="round"/>
        <path d="M248 168 C221 179 193 186 166 187" stroke="rgba(255,255,255,0.22)" stroke-width="3" stroke-linecap="round"/>
        <path d="M245 228 C219 238 193 244 168 244" stroke="rgba(255,255,255,0.18)" stroke-width="3" stroke-linecap="round"/>
        <path d="M260 108 C287 120 316 128 344 130" stroke="rgba(255,255,255,0.28)" stroke-width="3" stroke-linecap="round"/>
        <path d="M264 168 C291 179 319 186 346 187" stroke="rgba(255,255,255,0.22)" stroke-width="3" stroke-linecap="round"/>
        <path d="M267 228 C293 238 319 244 344 244" stroke="rgba(255,255,255,0.18)" stroke-width="3" stroke-linecap="round"/>
        <path d="M256 52 Q258 265 256 474" fill="none" stroke="url(#fgSpine)" stroke-width="3.5" stroke-linecap="round"/>
        <line x1="256" y1="476" x2="256" y2="500" stroke="#475569" stroke-width="5" stroke-linecap="round"/>
        <path d="M250 497 L256 512 L262 497" fill="#334155"/>
      </svg>
    </div>

    <!-- Purple feather - far right -->
    <div class="feather-float" style="right:-25px;transform:rotate(22deg) translateY(18px) scale(0.66);">
      <svg width="200" height="200" viewBox="0 0 512 512" fill="none">
        <path d="M256 50 C316 50 370 110 374 210 C378 310 352 390 314 440 L256 476 L198 440 C160 390 134 310 138 210 C142 110 196 50 256 50 Z" fill="url(#fgPurple)" filter="url(#fShadow)"/>
        <path d="M252 108 C225 120 196 128 168 130" stroke="rgba(255,255,255,0.28)" stroke-width="3" stroke-linecap="round"/>
        <path d="M248 168 C221 179 193 186 166 187" stroke="rgba(255,255,255,0.22)" stroke-width="3" stroke-linecap="round"/>
        <path d="M245 228 C219 238 193 244 168 244" stroke="rgba(255,255,255,0.18)" stroke-width="3" stroke-linecap="round"/>
        <path d="M260 108 C287 120 316 128 344 130" stroke="rgba(255,255,255,0.28)" stroke-width="3" stroke-linecap="round"/>
        <path d="M264 168 C291 179 319 186 346 187" stroke="rgba(255,255,255,0.22)" stroke-width="3" stroke-linecap="round"/>
        <path d="M267 228 C293 238 319 244 344 244" stroke="rgba(255,255,255,0.18)" stroke-width="3" stroke-linecap="round"/>
        <path d="M256 52 Q258 265 256 474" fill="none" stroke="url(#fgSpine)" stroke-width="3.5" stroke-linecap="round"/>
        <line x1="256" y1="476" x2="256" y2="500" stroke="#475569" stroke-width="5" stroke-linecap="round"/>
        <path d="M250 497 L256 512 L262 497" fill="#334155"/>
      </svg>
    </div>

    <!-- Red feather - center left -->
    <div class="feather-float" style="left:18%;transform:rotate(-6deg) translateY(12px) scale(0.83);">
      <svg width="200" height="200" viewBox="0 0 512 512" fill="none">
        <path d="M256 50 C316 50 370 110 374 210 C378 310 352 390 314 440 L256 476 L198 440 C160 390 134 310 138 210 C142 110 196 50 256 50 Z" fill="url(#fgRed)" filter="url(#fShadow)"/>
        <path d="M252 108 C225 120 196 128 168 130" stroke="rgba(255,255,255,0.28)" stroke-width="3" stroke-linecap="round"/>
        <path d="M248 168 C221 179 193 186 166 187" stroke="rgba(255,255,255,0.22)" stroke-width="3" stroke-linecap="round"/>
        <path d="M245 228 C219 238 193 244 168 244" stroke="rgba(255,255,255,0.18)" stroke-width="3" stroke-linecap="round"/>
        <path d="M260 108 C287 120 316 128 344 130" stroke="rgba(255,255,255,0.28)" stroke-width="3" stroke-linecap="round"/>
        <path d="M264 168 C291 179 319 186 346 187" stroke="rgba(255,255,255,0.22)" stroke-width="3" stroke-linecap="round"/>
        <path d="M267 228 C293 238 319 244 344 244" stroke="rgba(255,255,255,0.18)" stroke-width="3" stroke-linecap="round"/>
        <path d="M256 52 Q258 265 256 474" fill="none" stroke="url(#fgSpine)" stroke-width="3.5" stroke-linecap="round"/>
        <line x1="256" y1="476" x2="256" y2="500" stroke="#475569" stroke-width="5" stroke-linecap="round"/>
        <path d="M250 497 L256 512 L262 497" fill="#334155"/>
      </svg>
    </div>

    <!-- Blue feather - center right (interactive) -->
    <div class="feather-float bubble-wrap" style="right:22%;transform:rotate(12deg) translateY(-4px) scale(0.88);pointer-events:auto;">
      <div class="bubble" id="hb" style="bottom:calc(100% + 10px);top:auto;"></div>
      <div id="hp" onclick="penClick('hp','hb')" style="cursor:pointer;">
        <svg width="200" height="200" viewBox="0 0 512 512" fill="none">
          <g id="hpb">
            <path d="M256 50 C316 50 370 110 374 210 C378 310 352 390 314 440 L256 476 L198 440 C160 390 134 310 138 210 C142 110 196 50 256 50 Z" fill="url(#fgBlue)" filter="url(#fShadow)"/>
            <path d="M252 108 C225 120 196 128 168 130" stroke="rgba(255,255,255,0.28)" stroke-width="3" stroke-linecap="round"/>
            <path d="M248 168 C221 179 193 186 166 187" stroke="rgba(255,255,255,0.22)" stroke-width="3" stroke-linecap="round"/>
            <path d="M245 228 C219 238 193 244 168 244" stroke="rgba(255,255,255,0.18)" stroke-width="3" stroke-linecap="round"/>
            <path d="M260 108 C287 120 316 128 344 130" stroke="rgba(255,255,255,0.28)" stroke-width="3" stroke-linecap="round"/>
            <path d="M264 168 C291 179 319 186 346 187" stroke="rgba(255,255,255,0.22)" stroke-width="3" stroke-linecap="round"/>
            <path d="M267 228 C293 238 319 244 344 244" stroke="rgba(255,255,255,0.18)" stroke-width="3" stroke-linecap="round"/>
            <path d="M256 52 Q258 265 256 474" fill="none" stroke="url(#fgSpine)" stroke-width="3.5" stroke-linecap="round"/>
            <line x1="256" y1="476" x2="256" y2="500" stroke="#475569" stroke-width="5" stroke-linecap="round"/>
            <path d="M250 497 L256 512 L262 497" fill="#334155"/>
          </g>
        </svg>
      </div>
    </div>
  </div>
</div>

<!-- â•â• MODULE â•â• -->
<div id="mod" class="screen hidden">
  <div class="mod-head">
    <button class="btn-back" onclick="goHome()" title="Volver">&#8592;</button>
    <div class="mod-title-wrap">
      <div class="mod-title" id="mt">MÃ³dulo</div>
      <div class="mod-sub" id="ms"></div>
    </div>
    <div class="pen-sm-wrap bubble-wrap">
      <div class="bubble" id="mb"></div>
      <div class="pen pen-sm" id="mp" onclick="penClick('mp','mb')">
        <svg viewBox="0 0 100 100" fill="none">
          <g id="mpb">
            <path id="pc" d="M50 8 C64 8 78 22 80 42 C82 62 74 78 62 90 L50 97 L38 90 C26 78 18 62 20 42 C22 22 36 8 50 8 Z" fill="#2563eb"/>
            <path d="M50 8 C64 8 78 22 80 42 C82 62 74 78 62 90 L50 97" fill="rgba(255,255,255,0.08)"/>
            <path d="M50 9 Q51 53 50 96" stroke="rgba(255,255,255,0.7)" stroke-width="1.2" stroke-linecap="round" fill="none"/>
            <path d="M48 22 C41 25 34 27 27 27" stroke="rgba(255,255,255,0.28)" stroke-width="0.9" stroke-linecap="round"/>
            <path d="M47 34 C40 37 33 39 26 38" stroke="rgba(255,255,255,0.23)" stroke-width="0.9" stroke-linecap="round"/>
            <path d="M46 46 C39 49 32 50 25 50" stroke="rgba(255,255,255,0.20)" stroke-width="0.9" stroke-linecap="round"/>
            <path d="M52 22 C59 25 66 27 73 27" stroke="rgba(255,255,255,0.28)" stroke-width="0.9" stroke-linecap="round"/>
            <path d="M53 34 C60 37 67 39 74 38" stroke="rgba(255,255,255,0.23)" stroke-width="0.9" stroke-linecap="round"/>
            <path d="M54 46 C61 49 68 50 75 50" stroke="rgba(255,255,255,0.20)" stroke-width="0.9" stroke-linecap="round"/>
            <rect id="pcd" x="0" y="0" width="0" height="0" fill="#1d4ed8"/>
            <line x1="50" y1="97" x2="50" y2="100" stroke="#64748b" stroke-width="2" stroke-linecap="round"/>
          </g>
        </svg>
      </div>
    </div>
  </div>

  <div class="mod-body">

    <!-- INPUT TABS -->
    <div class="tabs">
      <button class="tab on" data-t="scan" onclick="switchTab('scan')">
        <span class="material-symbols-outlined tab-icon-default">crop_free</span>
        <span class="material-symbols-outlined tab-icon-buro">document_scanner</span>
        <span class="material-symbols-outlined tab-icon-other">add_a_photo</span>
        Escanear
      </button>
      <button class="tab" data-t="file" onclick="switchTab('file')">
        <span class="material-symbols-outlined">folder_open</span>
        Archivo
      </button>
      <button class="tab" data-t="text" onclick="switchTab('text')">
        <span class="material-symbols-outlined tab-text-default">edit_note</span>
        <span class="material-symbols-outlined tab-text-other">keyboard</span>
        Texto
      </button>
      <button class="tab" data-t="audio" onclick="switchTab('audio')">
        <span class="material-symbols-outlined">mic</span>
        Audio
      </button>
    </div>

    <!-- SCAN -->
    <div class="panel on" id="p-scan">
      <div class="drop" id="dz-scan"
           onclick="document.getElementById('fi-scan').click()"
           ondragover="dov(event)" ondragleave="dlv(event)" ondrop="ddrop(event,'scan')">
        <input type="file" id="fi-scan" accept="image/*" capture="environment" onchange="fsel(event,'scan')">
        <div class="drop-icon">ğŸ”</div>
        <p>Toca para abrir la cÃ¡mara</p>
        <small>o arrastra una imagen</small>
      </div>
      <div class="chip" id="ch-scan" style="display:none">
        ğŸ“· <span id="fn-scan"></span>
        <button onclick="clearF('scan')">âœ•</button>
      </div>
    </div>

    <!-- FILE -->
    <div class="panel" id="p-file">
      <div class="drop" id="dz-file"
           onclick="document.getElementById('fi-file').click()"
           ondragover="dov(event)" ondragleave="dlv(event)" ondrop="ddrop(event,'file')">
        <input type="file" id="fi-file" accept=".pdf,.doc,.docx,.txt,image/*" onchange="fsel(event,'file')">
        <div class="drop-icon">ğŸ“„</div>
        <p>Arrastra o toca para subir</p>
        <small>PDF, imagen, Word, texto</small>
      </div>
      <div class="chip" id="ch-file" style="display:none">
        ğŸ“„ <span id="fn-file"></span>
        <button onclick="clearF('file')">âœ•</button>
      </div>
    </div>

    <!-- TEXT -->
    <div class="panel" id="p-text">
      <div class="buro-chrome">
        <span class="buro-chrome-dot"></span>
        <span class="buro-chrome-label">Entrada Manual</span>
        <span class="buro-chrome-date" id="buro-date"></span>
      </div>
      <div class="rev-chrome">
        <div class="mac-dots">
          <span class="mac-dot red"></span>
          <span class="mac-dot amber"></span>
          <span class="mac-dot green"></span>
        </div>
        <span class="rev-mode-label">Modo Editor</span>
      </div>
      <div class="ta-wrap">
        <textarea class="lta" id="ta" placeholder="Escribe o pega tu texto aquÃ­â€¦" rows="6"></textarea>
        <button class="rev-paste-btn" title="Pegar"
          onclick="navigator.clipboard.readText().then(t=>{const ta=document.getElementById('ta');ta.value+=t}).catch(()=>{})">
          <span class="material-symbols-outlined">content_paste</span>
        </button>
      </div>
      <div class="simp-status">
        <span class="status-dot"></span>
        <span>EspaÃ±ol detectado</span>
      </div>
    </div>

    <!-- AUDIO -->
    <div class="panel" id="p-audio">
      <div class="audio-box">
        <button class="rec-btn" id="rb" onclick="toggleRec()">ğŸ™ï¸</button>
        <div class="rec-timer" id="rt">0:00</div>
        <div class="rec-lbl" id="rl">Toca para grabar</div>
        <div class="audio-prev" id="ap">
          <audio controls id="apl"></audio>
        </div>
      </div>
      <div class="audio-file-drop">
        <div class="drop" onclick="document.getElementById('fi-audio').click()" style="padding:1.1rem">
          <input type="file" id="fi-audio" accept="audio/*,video/*" onchange="asel(event)">
          <div class="drop-icon" style="font-size:1.4rem">ğŸµ</div>
          <p style="font-size:0.78rem">O sube un archivo de audio</p>
        </div>
        <div class="chip" id="ch-audio" style="display:none">
          ğŸµ <span id="fn-audio"></span>
          <button onclick="clearAudio()">âœ•</button>
        </div>
      </div>
    </div>

    <!-- MODULE EXTRAS -->
    <div id="mx"></div>

    <!-- SUBMIT -->
    <button class="btn-go" id="bg" onclick="submit()">
      <span id="bi">âœ¨</span> <span id="bl">Analizar</span>
    </button>

    <!-- ERROR -->
    <div class="err" id="er"></div>

    <!-- LOADING -->
    <div class="loading" id="ld">
      <div class="ld-pen">
        <svg width="64" height="64" viewBox="0 0 100 100" fill="none">
          <path id="lpc" d="M50 8 C64 8 78 22 80 42 C82 62 74 78 62 90 L50 97 L38 90 C26 78 18 62 20 42 C22 22 36 8 50 8 Z" fill="#2563eb"/>
          <path d="M50 8 C64 8 78 22 80 42 C82 62 74 78 62 90 L50 97" fill="rgba(255,255,255,0.08)"/>
          <path d="M50 9 Q51 53 50 96" stroke="rgba(255,255,255,0.7)" stroke-width="1.2" stroke-linecap="round" fill="none"/>
          <path d="M48 22 C41 25 34 27 27 27" stroke="rgba(255,255,255,0.28)" stroke-width="0.9" stroke-linecap="round"/>
          <path d="M47 34 C40 37 33 39 26 38" stroke="rgba(255,255,255,0.23)" stroke-width="0.9" stroke-linecap="round"/>
          <path d="M52 22 C59 25 66 27 73 27" stroke="rgba(255,255,255,0.28)" stroke-width="0.9" stroke-linecap="round"/>
          <path d="M53 34 C60 37 67 39 74 38" stroke="rgba(255,255,255,0.23)" stroke-width="0.9" stroke-linecap="round"/>
          <line x1="50" y1="97" x2="50" y2="100" stroke="#64748b" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      <div class="ld-phrase" id="lp">Procesandoâ€¦</div>
      <div class="ld-dots"><span></span><span></span><span></span></div>
    </div>

    <!-- RESULTS -->
    <div class="results" id="res"></div>

  </div>
</div>

<!-- â•â• SCRIPT â•â• -->
<script>
const API = 'https://lumen-backend-674628598121.europe-west1.run.app';

const MODS = {
  simplificar: {
    title: 'Simplificar',
    sub: 'Adapta textos difÃ­ciles a lenguaje claro',
    color: '#2563eb', dark: '#1d4ed8', bg: '#eff6ff',
    label: 'Simplificar',
    endpoint: '/traduceme',
    phrases: ['Leyendo el textoâ€¦','Buscando palabras mÃ¡s clarasâ€¦','Eliminando tecnicismosâ€¦','Casi listoâ€¦'],
  },
  burocracia: {
    title: 'Burocracia',
    sub: 'Entiende documentos oficiales',
    color: '#16a34a', dark: '#15803d', bg: '#f0fdf4',
    label: 'Analizar documento',
    endpoint: '/burocracia',
    phrases: ['Descifrando el lenguaje oficialâ€¦','Identificando tus derechosâ€¦','Organizando la informaciÃ³nâ€¦','Casi listoâ€¦'],
  },
  apuntes: {
    title: 'Apuntes',
    sub: 'Transcribe y resume',
    color: '#ea580c', dark: '#c2410c', bg: '#fff7ed',
    label: 'Transcribir y resumir',
    endpoint: '/apuntes',
    phrases: ['Escuchando el audioâ€¦','Transcribiendo con Whisperâ€¦','Identificando puntos claveâ€¦','Casi listoâ€¦'],
  },
  revision: {
    title: 'RevisiÃ³n',
    sub: 'Mejora lo que escribes',
    color: '#7c3aed', dark: '#6d28d9', bg: '#f5f3ff',
    label: 'Revisar y mejorar',
    endpoint: '/revision',
    phrases: ['Leyendo tu textoâ€¦','Ajustando el tonoâ€¦','Buscando la versiÃ³n perfectaâ€¦','Casi listoâ€¦'],
  },
};

const PHRASES = ['Â¡AquÃ­ estoy!','A tu servicio.','Â¿Necesitas algo?','Â¡Vamos!','Soy todo oÃ­dos.','Listo para escribir.'];
const SPLASH_PH = ['Preparando la tintaâ€¦','Afilando la puntaâ€¦','Cargando palabrasâ€¦','Casi listoâ€¦'];

let curMod = null, curTab = 'scan';
let scanF = null, docF = null, audBlob = null, audFile = null;
let mr = null, recChunks = [], recSec = 0, recInt = null, isRec = false;
let simpResult = null;
let ctxSel = 'Trabajo';

// â”€â”€ INIT â”€â”€
window.addEventListener('load', () => {
  startCanvas();
  splashGo();
  fetch(API + '/').catch(() => {});
});

// â”€â”€ SPLASH â”€â”€
function splashGo() {
  let i = 0;
  const el = document.getElementById('sph');
  const cycle = setInterval(() => {
    i++;
    if (i >= SPLASH_PH.length) { clearInterval(cycle); return; }
    el.style.opacity = 0;
    setTimeout(() => { el.innerHTML = SPLASH_PH[i]; el.style.opacity = 1; }, 280);
  }, 900);
  setTimeout(toHome, 3000);
}
function toHome() {
  const s = document.getElementById('splash');
  s.style.transition = 'opacity 0.45s';
  s.style.opacity = 0;
  setTimeout(() => show('home'), 450);
}

// â”€â”€ SCREEN TRANSITIONS â”€â”€
function show(id) {
  document.querySelectorAll('.screen').forEach(s => {
    s.classList.add('hidden');
  });
  const el = document.getElementById(id);
  el.classList.remove('hidden', 'slide-back');
  el.scrollTop = 0;
}

function goHome() {
  resetMod();
  show('home');
}

// â”€â”€ OPEN MODULE â”€â”€
function openMod(id) {
  curMod = id;
  const c = MODS[id];
  const r = document.documentElement;
  r.style.setProperty('--mod', c.color);
  r.style.setProperty('--mod-bg', c.bg);
  document.getElementById('pc').setAttribute('fill', c.color);
  document.getElementById('pcd').setAttribute('fill', c.dark);
  document.getElementById('lpc').setAttribute('fill', c.color);
  document.getElementById('mt').textContent = c.title;
  document.getElementById('ms').textContent = c.sub;
  document.getElementById('bl').textContent = c.label;
  document.getElementById('mod').setAttribute('data-mod', id);
  const bd = document.getElementById('buro-date');
  if (bd) { const now = new Date(); bd.textContent = now.toLocaleDateString('es-ES',{day:'2-digit',month:'short',year:'numeric'}).toUpperCase(); }
  switchTab('scan');
  renderExtras(id);
  clearResults();
  show('mod');
}

// â”€â”€ EXTRAS â”€â”€
function renderExtras(id) {
  const el = document.getElementById('mx');
  if (id === 'revision') {
    el.innerHTML = `
      <div style="margin-bottom:1rem">
        <label class="field-lbl">Contexto del mensaje</label>
        <div class="ctx-grid">
          ${[['Trabajo','ğŸ’¼'],['Pareja','ğŸ’›'],['Familia','ğŸ '],['Legal','âš–ï¸']].map(([l,ic]) =>
            `<button class="ctx-btn${l===ctxSel?' on':''}" onclick="setSel('${l}',this)">${ic} ${l}</button>`
          ).join('')}
        </div>
      </div>`;
  } else {
    el.innerHTML = '';
  }
}

function setSel(v, btn) {
  ctxSel = v;
  btn.closest('.ctx-grid').querySelectorAll('.ctx-btn').forEach(b => b.classList.remove('on'));
  btn.classList.add('on');
}

// â”€â”€ TABS â”€â”€
function switchTab(t) {
  curTab = t;
  document.querySelectorAll('.tab').forEach(b => b.classList.toggle('on', b.dataset.t === t));
  document.querySelectorAll('.panel').forEach(p => p.classList.toggle('on', p.id === 'p-'+t));
}

// â”€â”€ FILE HANDLING â”€â”€
function fsel(e, type) {
  const f = e.target.files[0]; if (!f) return;
  if (type === 'scan') { scanF = f; document.getElementById('fn-scan').textContent = f.name; document.getElementById('ch-scan').style.display='inline-flex'; }
  else { docF = f; document.getElementById('fn-file').textContent = f.name; document.getElementById('ch-file').style.display='inline-flex'; }
}
function clearF(type) {
  if (type === 'scan') { scanF = null; document.getElementById('fi-scan').value=''; document.getElementById('ch-scan').style.display='none'; }
  else { docF = null; document.getElementById('fi-file').value=''; document.getElementById('ch-file').style.display='none'; }
}
function dov(e) { e.preventDefault(); e.currentTarget.classList.add('over'); }
function dlv(e) { e.currentTarget.classList.remove('over'); }
function ddrop(e, type) {
  e.preventDefault(); e.currentTarget.classList.remove('over');
  const f = e.dataTransfer.files[0]; if (!f) return;
  fsel({ target: { files: [f] } }, type);
}

// â”€â”€ AUDIO â”€â”€
async function toggleRec() {
  if (!isRec) {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mr = new MediaRecorder(stream);
      recChunks = [];
      mr.ondataavailable = e => recChunks.push(e.data);
      mr.onstop = () => {
        audBlob = new Blob(recChunks, { type: 'audio/webm' });
        const url = URL.createObjectURL(audBlob);
        document.getElementById('apl').src = url;
        document.getElementById('ap').style.display = 'block';
        stream.getTracks().forEach(t => t.stop());
      };
      mr.start(); isRec = true; recSec = 0;
      document.getElementById('rb').classList.add('on');
      document.getElementById('rb').textContent = 'â¹ï¸';
      document.getElementById('rl').textContent = 'Grabandoâ€¦ toca para detener';
      document.getElementById('rt').style.display = 'block';
      recInt = setInterval(() => {
        recSec++;
        const m = Math.floor(recSec/60), s = recSec%60;
        document.getElementById('rt').textContent = `${m}:${s.toString().padStart(2,'0')}`;
      }, 1000);
    } catch(e) { showErr('No se pudo acceder al micrÃ³fono.'); }
  } else {
    mr.stop(); isRec = false; clearInterval(recInt);
    document.getElementById('rb').classList.remove('on');
    document.getElementById('rb').textContent = 'ğŸ™ï¸';
    document.getElementById('rl').textContent = 'GrabaciÃ³n guardada. Toca para grabar de nuevo.';
    document.getElementById('rt').style.display = 'none';
  }
}
function asel(e) {
  audFile = e.target.files[0]; if (!audFile) return;
  document.getElementById('fn-audio').textContent = audFile.name;
  document.getElementById('ch-audio').style.display = 'inline-flex';
}
function clearAudio() {
  audFile = null;
  document.getElementById('fi-audio').value = '';
  document.getElementById('ch-audio').style.display = 'none';
}

// â”€â”€ SUBMIT â”€â”€
async function submit() {
  hideErr();
  const c = MODS[curMod];
  let isJson = false;
  let fd = new FormData();
  let jsonBody = null;
  let ok = false;

  if (curTab === 'text') {
    const t = document.getElementById('ta').value.trim();
    if (!t) { showErr('Escribe o pega texto antes de continuar.'); return; }
    isJson = true;
    jsonBody = { text: t };
    if (curMod === 'revision') jsonBody.contexto = ctxSel;
    ok = true;
  } else if (curTab === 'scan') {
    if (!scanF) { showErr('Selecciona o escanea una imagen.'); return; }
    fd.append('image', scanF); ok = true;
  } else if (curTab === 'file') {
    if (!docF) { showErr('Selecciona un archivo.'); return; }
    fd.append('file', docF); ok = true;
  } else if (curTab === 'audio') {
    const blob = audFile || audBlob;
    if (!blob) { showErr('Graba o sube un audio primero.'); return; }
    fd.append('audio', blob instanceof File ? blob : new File([blob], 'rec.webm', { type: 'audio/webm' }));
    ok = true;
  }
  if (!ok) return;

  if (!isJson && curMod === 'revision') fd.append('contexto', ctxSel);

  showLoad();
  let pi = 0;
  const pit = setInterval(() => {
    pi = (pi+1) % c.phrases.length;
    const lp = document.getElementById('lp');
    lp.style.opacity = 0;
    setTimeout(() => { lp.textContent = c.phrases[pi]; lp.style.opacity = 1; }, 280);
  }, 2000);

  try {
    // Step 1: if image/file â†’ extract text via /scan
    if (curTab === 'scan' || curTab === 'file') {
      const sr = await fetch(API + '/scan', { method: 'POST', body: fd });
      if (!sr.ok) throw new Error('Error al procesar imagen (' + sr.status + ')');
      const sd = await sr.json();
      const txt = sd.text || '';
      if (!txt) throw new Error('No se pudo extraer texto de la imagen.');
      fd = new FormData();
      fd.append('text', txt);
      if (curMod === 'revision') fd.append('contexto', ctxSel);
    }

    // Step 2: if audio â†’ transcribe first, then send text to module endpoint
    if (curTab === 'audio') {
      const tr = await fetch(API + '/transcribe', { method: 'POST', body: fd });
      if (!tr.ok) throw new Error('Error al transcribir audio (' + tr.status + ')');
      const td = await tr.json();
      const txt = td.text || '';
      if (!txt) throw new Error('No se pudo transcribir el audio.');
      fd = new FormData();
      fd.append('text', txt);
      if (curMod === 'revision') fd.append('contexto', ctxSel);
    }

    // After scan/audio processing, text is in fd as FormData â†’ convert to JSON
    if (!isJson && (curTab === 'scan' || curTab === 'file' || curTab === 'audio')) {
      const extractedText = fd.get('text');
      if (extractedText) {
        isJson = true;
        jsonBody = { text: extractedText };
        if (curMod === 'revision') jsonBody.contexto = ctxSel;
      }
    }

    const fetchOpts = isJson
      ? { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(jsonBody) }
      : { method: 'POST', body: fd };

    const r = await fetch(API + c.endpoint, fetchOpts);
    clearInterval(pit);
    if (!r.ok) throw new Error('Error del servidor ('+r.status+')');
    const data = await r.json();
    hideLoad();
    renderRes(data);
  } catch(e) {
    clearInterval(pit);
    hideLoad();
    showErr('Error: ' + e.message);
  }
}

// â”€â”€ RENDER RESULTS â”€â”€
function renderRes(data) {
  const el = document.getElementById('res');
  el.innerHTML = '';
  el.classList.remove('on');

  if (curMod === 'simplificar') {
    // Backend returns: { nino, normal, experto, conceptos }
    simpResult = { simple: data.nino || '', completa: data.normal || '' };
    el.innerHTML = `
      <div class="vtoggle">
        <button class="vbtn on" id="vsim" onclick="showV('simple')">Simple</button>
        <button class="vbtn" id="vcom" onclick="showV('completa')">Completa</button>
      </div>
      ${rcard('VersiÃ³n simplificada', simpResult.simple, 'vtext')}
      ${savebtn()}`;
  } else if (curMod === 'burocracia') {
    // Backend returns: { que_dicen, que_hago, y_si_no, derechos[], deberes[] }
    const der = Array.isArray(data.derechos) ? data.derechos.join('\n') : (data.derechos||'');
    const deb = Array.isArray(data.deberes) ? data.deberes.join('\n') : (data.deberes||'');
    el.innerHTML = `
      <div class="buro-cols">
        <div class="bcol"><div class="bcol-t">\u00bfQu\u00e9 te piden?</div><div class="bcol-b">${esc(data.que_dicen||'')}</div></div>
        <div class="bcol"><div class="bcol-t">\u00bfQu\u00e9 hago?</div><div class="bcol-b">${esc(data.que_hago||'')}</div></div>
        <div class="bcol"><div class="bcol-t">\u00bfY si no lo hago?</div><div class="bcol-b">${esc(data.y_si_no||'')}</div></div>
      </div>
      <div class="rd-grid">
        <div class="rd-card r"><div class="rd-t">Tus derechos</div><div class="rd-b">${esc(der)}</div></div>
        <div class="rd-card d"><div class="rd-t">Tus obligaciones</div><div class="rd-b">${esc(deb)}</div></div>
      </div>
      ${savebtn()}`;
  } else if (curMod === 'apuntes') {
    // Backend returns: { resumen, puntos_clave[], accionables[], sin_resolver[] }
    const pk = Array.isArray(data.puntos_clave) ? data.puntos_clave.map((p,i)=>`${i+1}. ${p}`).join('\n') : (data.puntos_clave||'');
    const ac = Array.isArray(data.accionables) ? data.accionables.map(a=>typeof a==='object'?(a.tarea+(a.responsable?` (${a.responsable})`:'')):a).join('\n') : '';
    const sr = Array.isArray(data.sin_resolver) ? data.sin_resolver.join('\n') : (data.sin_resolver||'');
    el.innerHTML = `
      ${rcard('Resumen', data.resumen||'', 'asum')}
      ${pk ? rcard('Puntos clave', pk, 'apk') : ''}
      ${ac ? rcard('Accionables', ac, 'aac') : ''}
      ${sr ? rcard('Temas sin resolver', sr, 'asr') : ''}
      ${savebtn()}`;
  } else if (curMod === 'revision') {
    // Backend returns: { problemas[], version_mejorada, tono_general, score_sentimiento }
    const probs = Array.isArray(data.problemas) && data.problemas.length
      ? data.problemas.map(p=>`\u2022 ${p.frase}: ${p.explicacion}`).join('\n') : '';
    el.innerHTML = `
      ${rcard('Texto mejorado', data.version_mejorada||'', 'rtx')}
      ${probs ? rcard('Observaciones', probs, 'robs') : ''}
      ${savebtn()}`;
  }

  el.classList.add('on');
  setTimeout(() => el.scrollIntoView({ behavior: 'smooth', block: 'start' }), 50);
}

function rcard(title, text, id) {
  return `<div class="res-card">
    <div class="res-head">
      <div class="res-label"><div class="res-dot"></div>${title}</div>
      <button class="btn-copy" onclick="cp('${id}')" title="Copiar">ğŸ“‹</button>
    </div>
    <div class="res-body" id="${id}">${esc(text)}</div>
  </div>`;
}

function savebtn() {
  return `<button class="btn-save" onclick="saveImg()">â¬‡ Guardar imagen</button>`;
}

function showV(v) {
  const el = document.getElementById('vtext');
  if (!el || !simpResult) return;
  el.innerHTML = esc(v==='simple' ? (simpResult.simple||simpResult.result||'') : (simpResult.completa||simpResult.complete||simpResult.result||''));
  document.getElementById('vsim').classList.toggle('on', v==='simple');
  document.getElementById('vcom').classList.toggle('on', v==='completa');
}

// â”€â”€ UTILS â”€â”€
function esc(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
}
function cp(id) {
  const el = document.getElementById(id); if (!el) return;
  navigator.clipboard.writeText(el.innerText||el.textContent).catch(()=>{});
}
async function saveImg() {
  if (typeof html2canvas === 'undefined') { showErr('html2canvas no disponible.'); return; }
  try {
    const c = await html2canvas(document.getElementById('res'), { backgroundColor: '#faf8f4', scale: 2 });
    const a = document.createElement('a');
    a.download = `lumen-${curMod}-${Date.now()}.png`;
    a.href = c.toDataURL('image/png'); a.click();
  } catch(e) { showErr('No se pudo guardar.'); }
}

function showLoad() {
  document.getElementById('bg').disabled = true;
  const c = MODS[curMod];
  document.getElementById('lp').textContent = c.phrases[0];
  document.getElementById('ld').classList.add('on');
  document.getElementById('res').classList.remove('on');
}
function hideLoad() {
  document.getElementById('bg').disabled = false;
  document.getElementById('ld').classList.remove('on');
}
function showErr(msg) {
  const el = document.getElementById('er'); el.textContent = msg; el.classList.add('on');
}
function hideErr() { document.getElementById('er').classList.remove('on'); }
function clearResults() {
  hideErr(); hideLoad();
  const r = document.getElementById('res'); r.innerHTML = ''; r.classList.remove('on');
}
function resetMod() {
  scanF = null; docF = null; audBlob = null; audFile = null;
  if (isRec) { try { mr.stop(); } catch(e){} isRec = false; }
  clearInterval(recInt); simpResult = null;
}

// â”€â”€ PEN CLICK â”€â”€
function penClick(penId, bubId) {
  const phrase = PHRASES[Math.floor(Math.random()*PHRASES.length)];
  const b = document.getElementById(bubId);
  b.textContent = phrase; b.classList.add('show');
  clearTimeout(b._t); b._t = setTimeout(() => b.classList.remove('show'), 2500);
  const pen = document.getElementById(penId);
  pen.style.transition = 'transform 0.1s'; pen.style.transform = 'rotate(-10deg) scale(1.08)';
  setTimeout(() => { pen.style.transform = ''; }, 350);
  if (navigator.vibrate) navigator.vibrate(25);
}

// â”€â”€ WORD CANVAS â”€â”€
const WPOOL = {
  default: ['texto','palabra','frase','nota','ideas','lumen','escribe','lee','piensa','entiende','claridad','boli'],
  simplificar: ['simple','claro','fÃ¡cil','entender','adaptar','vocabulario','lenguaje','sentido','bÃ¡sico','comprensible'],
  burocracia: ['artÃ­culo','decreto','resoluciÃ³n','notificaciÃ³n','plazo','derecho','deber','trÃ¡mite','expediente','cÃ³digo'],
  apuntes: ['reuniÃ³n','idea','tarea','resumen','clave','notas','audio','voz','acciÃ³n','punto','grabar'],
  revision: ['tono','estilo','claridad','mensaje','carta','email','mejorar','pulir','registro','redactar'],
};

let ws = [];
function startCanvas() {
  const cv = document.getElementById('wc');
  const cx = cv.getContext('2d');
  function rs() { cv.width = innerWidth; cv.height = innerHeight; }
  rs(); addEventListener('resize', rs);

  function pool() { return WPOOL[curMod] || WPOOL.default; }
  function spawn() {
    const p = pool(), w = p[Math.floor(Math.random()*p.length)];
    ws.push({ t: w, x: 60+Math.random()*(cv.width-80), y: 20+Math.random()*(cv.height-30),
      sz: 10+Math.random()*9, a: 0, ph: 'in', life: 0, max: 160+Math.random()*120 });
  }
  setInterval(spawn, 900);
  function tick() {
    cx.clearRect(0,0,cv.width,cv.height);
    ws = ws.filter(w => w.ph !== 'dead');
    for (const w of ws) {
      w.life++;
      if (w.ph==='in')   { w.a = Math.min(1, w.life/28); if (w.a>=1) w.ph='hold'; }
      else if (w.ph==='hold') { if (w.life>=w.max) w.ph='out'; }
      else if (w.ph==='out')  { w.a -= 0.022; if (w.a<=0) w.ph='dead'; }
      cx.save(); cx.globalAlpha=w.a;
      cx.font=`italic ${w.sz}px Georgia,serif`;
      cx.fillStyle='#1a1714'; cx.fillText(w.t,w.x,w.y);
      cx.restore();
    }
    if (ws.length < 16) spawn();
    requestAnimationFrame(tick);
  }
  tick();
}
</script>

<!-- html2canvas lazy loaded -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
</body>
</html>
