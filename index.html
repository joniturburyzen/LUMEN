<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Lumen">
<meta name="theme-color" content="#2563eb">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>Lumen</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --paper: #faf8f4;
  --ink: #1a1714;
  --ink-light: #6b6560;
  --ink-faint: #b0a898;
  --line: #e0d8cc;
  --line-spacing: 32px;
  --radius: 14px;
  --shadow: 0 2px 16px rgba(0,0,0,0.07), 0 1px 3px rgba(0,0,0,0.05);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
  --blue:   #2563eb; --blue-bg: #eff6ff;
  --green:  #16a34a; --green-bg: #f0fdf4;
  --orange: #ea580c; --orange-bg: #fff7ed;
  --violet: #7c3aed; --violet-bg: #f5f3ff;
  --mod: var(--blue);
  --mod-bg: var(--blue-bg);
}

html, body { height: 100%; }
body {
  font-family: Georgia, 'Times New Roman', serif;
  background: var(--paper);
  color: var(--ink);
  overflow: hidden;
}

/* Paper lines */
body::before {
  content: '';
  position: fixed; inset: 0;
  background-image: repeating-linear-gradient(
    transparent, transparent calc(var(--line-spacing) - 1px),
    var(--line) calc(var(--line-spacing) - 1px), var(--line) var(--line-spacing)
  );
  background-position: 0 44px;
  pointer-events: none; z-index: 0; opacity: 0.5;
}
/* Red margin */
body::after {
  content: '';
  position: fixed; top: 0; left: 52px;
  width: 1.5px; height: 100%;
  background: rgba(220,80,80,0.2);
  pointer-events: none; z-index: 0;
}

/* â”€â”€ WORD CANVAS â”€â”€ */
#wc {
  position: fixed; inset: 0;
  pointer-events: none; z-index: 1;
}

/* â”€â”€ SCREENS â”€â”€ */
.screen {
  position: fixed; inset: 0;
  z-index: 10;
  display: flex; flex-direction: column;
  background: transparent;
  overflow-y: auto;
  transition: opacity 0.3s ease, transform 0.3s ease;
}
.screen.hidden {
  opacity: 0;
  pointer-events: none;
  transform: translateX(24px);
}
.screen.slide-back { transform: translateX(-24px); }

/* â”€â”€ PEN SVG â”€â”€ */
.pen { display: inline-block; cursor: pointer; filter: drop-shadow(0 3px 8px rgba(0,0,0,0.18)); }
.pen:active { transform: scale(0.93) rotate(-5deg); }
.pen svg { display: block; }
.pen-lg svg { width: 80px; height: 80px; }
.pen-sm svg { width: 40px; height: 40px; }

/* â”€â”€ BUBBLE â”€â”€ */
.bubble-wrap { position: relative; display: inline-block; }
.bubble {
  position: absolute;
  bottom: calc(100% + 10px); left: 50%;
  transform: translateX(-50%) translateY(4px);
  background: var(--ink); color: var(--paper);
  padding: 6px 12px; border-radius: 10px;
  font-size: 0.78rem; font-style: italic;
  white-space: nowrap; pointer-events: none;
  opacity: 0; transition: opacity 0.2s, transform 0.2s;
  z-index: 200;
}
.bubble::after {
  content: ''; position: absolute;
  top: 100%; left: 50%; transform: translateX(-50%);
  border: 5px solid transparent; border-top-color: var(--ink);
}
.bubble.show { opacity: 1; transform: translateX(-50%) translateY(0); }
/* small pen bubble goes down */
.pen-sm-wrap .bubble {
  bottom: auto; top: calc(100% + 10px);
}
.pen-sm-wrap .bubble::after {
  top: auto; bottom: 100%;
  border-top-color: transparent; border-bottom-color: var(--ink);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SPLASH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#splash {
  align-items: center; justify-content: center;
  text-align: center; padding: 2rem;
}
.splash-logo {
  font-size: clamp(3rem, 12vw, 5.5rem);
  font-weight: normal; letter-spacing: -0.02em;
  margin-top: 1.2rem;
  animation: fadeUp 0.6s 0.3s ease both;
}
.splash-sub {
  font-style: italic; color: var(--ink-light);
  font-size: 1rem; margin-top: 0.3rem;
  animation: fadeUp 0.6s 0.6s ease both;
}
.splash-phrase {
  font-style: italic; color: var(--ink-light);
  font-size: 0.9rem; margin-top: 2rem;
  min-height: 1.4rem;
  animation: fadeUp 0.5s 1s ease both;
  transition: opacity 0.3s;
}
.dots span {
  display: inline-block;
  animation: dot 1.2s ease infinite;
}
.dots span:nth-child(2) { animation-delay: 0.2s; }
.dots span:nth-child(3) { animation-delay: 0.4s; }
@keyframes dot {
  0%,80%,100% { opacity: 0.2; transform: scale(0.7); }
  40% { opacity: 1; transform: scale(1); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HOME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#home { padding: 0 0 3rem; }
.home-head {
  padding: 2.5rem 1.5rem 0.5rem;
  display: flex; flex-direction: column;
  align-items: center; text-align: center;
}
.home-logo {
  font-size: clamp(2rem, 7vw, 3rem);
  font-weight: normal; margin-top: 0.6rem;
}
.home-tag {
  font-style: italic; color: var(--ink-light);
  font-size: 0.9rem; margin-top: 0.2rem;
}
.grid {
  display: grid; grid-template-columns: 1fr 1fr;
  gap: 0.9rem; padding: 1.5rem 1.1rem;
  max-width: 560px; margin: 0 auto; width: 100%;
}
.card {
  background: white; border-radius: var(--radius);
  padding: 1.3rem 1.1rem;
  cursor: pointer; position: relative;
  box-shadow: var(--shadow);
  border: 1.5px solid transparent;
  transition: transform 0.18s, box-shadow 0.18s, border-color 0.18s;
  -webkit-tap-highlight-color: transparent;
  overflow: hidden;
}
.card::before {
  content: ''; position: absolute;
  top: 0; left: 0; right: 0; height: 3px;
  background: var(--c);
}
.card:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); border-color: var(--c); }
.card:active { transform: scale(0.97); }
.card[data-m="simplificar"] { --c: var(--blue); }
.card[data-m="burocracia"]  { --c: var(--green); }
.card[data-m="apuntes"]     { --c: var(--orange); }
.card[data-m="revision"]    { --c: var(--violet); }
.card-icon {
  width: 34px; height: 34px; border-radius: 9px;
  background: color-mix(in srgb, var(--c) 13%, transparent);
  color: var(--c);
  display: flex; align-items: center; justify-content: center;
  margin-bottom: 0.7rem; font-size: 1.1rem;
}
.card-name { font-size: 1rem; font-weight: normal; color: var(--ink); }
.card-desc { font-size: 0.75rem; color: var(--ink-light); margin-top: 0.25rem; font-style: italic; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODULE SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#mod { padding-bottom: 3rem; }
.mod-head {
  display: flex; align-items: center; gap: 0.6rem;
  padding: 1rem 1rem 0.8rem;
  position: sticky; top: 0;
  background: rgba(250,248,244,0.93);
  backdrop-filter: blur(10px);
  border-bottom: 1px solid var(--line);
  z-index: 50;
}
.btn-back {
  background: none; border: none; cursor: pointer;
  color: var(--ink-light); padding: 6px;
  border-radius: 8px; display: flex;
  transition: color 0.15s, background 0.15s;
  -webkit-tap-highlight-color: transparent;
  flex-shrink: 0; font-size: 1.3rem; line-height: 1;
}
.btn-back:hover { color: var(--ink); background: var(--line); }
.mod-title-wrap { flex: 1; }
.mod-title {
  font-size: 1.2rem; font-weight: normal;
  color: var(--ink);
}
.mod-sub { font-size: 0.72rem; color: var(--ink-faint); font-style: italic; }
.pen-sm-wrap { position: relative; }
.mod-body { padding: 1.1rem; max-width: 640px; margin: 0 auto; width: 100%; }

/* â”€â”€ Input tabs â”€â”€ */
.tabs {
  display: flex; background: white;
  border-radius: 12px; padding: 3px; gap: 2px;
  box-shadow: var(--shadow); margin-bottom: 1.1rem;
}
.tab {
  flex: 1; background: none; border: none; cursor: pointer;
  padding: 0.5rem 0.2rem; border-radius: 9px;
  font-family: Georgia, serif; font-size: 0.7rem;
  color: var(--ink-light);
  display: flex; flex-direction: column;
  align-items: center; gap: 3px;
  transition: background 0.18s, color 0.18s;
  -webkit-tap-highlight-color: transparent;
}
.tab .ti { font-size: 1rem; line-height: 1; }
.tab.on { background: var(--mod); color: white; }
.tab:hover:not(.on) { background: var(--line); color: var(--ink); }

/* â”€â”€ Panels â”€â”€ */
.panel { display: none; }
.panel.on { display: block; }

.drop {
  border: 2px dashed var(--line); border-radius: var(--radius);
  padding: 2.2rem 1rem; text-align: center;
  cursor: pointer; background: white;
  transition: border-color 0.2s, background 0.2s;
}
.drop:hover, .drop.over { border-color: var(--mod); background: var(--mod-bg); }
.drop input { display: none; }
.drop-icon { font-size: 2rem; opacity: 0.35; margin-bottom: 0.4rem; }
.drop p { font-size: 0.82rem; color: var(--ink-light); font-style: italic; }
.drop small { font-size: 0.72rem; color: var(--ink-faint); }

textarea.lta {
  width: 100%; border: 1.5px solid var(--line);
  border-radius: var(--radius); padding: 0.9rem;
  font-family: Georgia, serif; font-size: 0.95rem;
  color: var(--ink); background: white;
  resize: vertical; min-height: 130px;
  outline: none; line-height: 1.7;
  transition: border-color 0.2s;
}
textarea.lta:focus { border-color: var(--mod); }

.chip {
  display: inline-flex; align-items: center; gap: 0.4rem;
  background: var(--mod-bg);
  border: 1px solid color-mix(in srgb, var(--mod) 30%, transparent);
  color: var(--mod); border-radius: 20px;
  padding: 0.3rem 0.7rem; font-size: 0.78rem; margin-top: 0.6rem;
}
.chip button {
  background: none; border: none; cursor: pointer;
  color: var(--mod); display: flex; padding: 0; font-size: 1rem; line-height: 1;
}

/* Audio */
.audio-box {
  background: white; border-radius: var(--radius);
  padding: 1.5rem; text-align: center;
  box-shadow: var(--shadow);
}
.rec-btn {
  width: 68px; height: 68px; border-radius: 50%; border: none;
  background: var(--mod); color: white; cursor: pointer;
  display: inline-flex; align-items: center; justify-content: center;
  font-size: 1.6rem;
  transition: transform 0.2s, box-shadow 0.2s;
  box-shadow: 0 4px 18px color-mix(in srgb, var(--mod) 35%, transparent);
  margin-bottom: 0.6rem;
}
.rec-btn:hover { transform: scale(1.06); }
.rec-btn.on {
  background: #dc2626;
  animation: pulse 1.2s ease infinite;
  box-shadow: 0 4px 18px rgba(220,38,38,0.4);
}
@keyframes pulse {
  0%,100% { transform: scale(1); }
  50% { transform: scale(1.07); }
}
.rec-lbl { font-size: 0.8rem; color: var(--ink-light); font-style: italic; }
.rec-timer { font-size: 1.2rem; color: var(--ink); margin: 0.3rem 0; display: none; }
.audio-prev { margin-top: 0.9rem; display: none; }
.audio-prev audio { width: 100%; }
.audio-file-drop { margin-top: 0.9rem; }
.audio-file-drop .drop { padding: 1.2rem; }

/* Module extras */
.field-lbl {
  font-size: 0.72rem; letter-spacing: 0.05em;
  text-transform: uppercase; color: var(--ink-light);
  margin-bottom: 0.35rem; display: block;
}
.ctx-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.45rem; margin-bottom: 1rem; }
.ctx-btn {
  border: 1.5px solid var(--line); background: white;
  border-radius: 10px; padding: 0.55rem 0.4rem;
  cursor: pointer; font-family: Georgia, serif;
  font-size: 0.8rem; color: var(--ink-light);
  display: flex; align-items: center; gap: 0.35rem;
  justify-content: center;
  transition: all 0.18s;
  -webkit-tap-highlight-color: transparent;
}
.ctx-btn.on { border-color: var(--mod); background: var(--mod-bg); color: var(--mod); }

/* Submit */
.btn-go {
  width: 100%; background: var(--mod); color: white;
  border: none; border-radius: var(--radius);
  padding: 0.95rem; font-family: Georgia, serif;
  font-size: 1rem; cursor: pointer;
  display: flex; align-items: center; justify-content: center; gap: 0.5rem;
  margin-top: 1.1rem;
  transition: transform 0.15s, box-shadow 0.15s, opacity 0.15s;
  box-shadow: 0 4px 14px color-mix(in srgb, var(--mod) 30%, transparent);
  -webkit-tap-highlight-color: transparent;
}
.btn-go:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 8px 22px color-mix(in srgb, var(--mod) 40%, transparent);
}
.btn-go:disabled { opacity: 0.55; cursor: not-allowed; transform: none; }

/* Error */
.err {
  background: #fef2f2; border: 1.5px solid #fca5a5;
  border-radius: var(--radius); padding: 0.9rem 1.1rem;
  color: #991b1b; font-size: 0.85rem;
  display: none; margin-top: 0.9rem;
}
.err.on { display: block; }

/* Loading */
.loading {
  display: none; flex-direction: column;
  align-items: center; justify-content: center;
  padding: 2.5rem 1rem; text-align: center;
}
.loading.on { display: flex; }
.ld-pen { animation: bob 0.65s ease infinite alternate; }
@keyframes bob {
  from { transform: translateY(0) rotate(-4deg); }
  to   { transform: translateY(-14px) rotate(4deg); }
}
.ld-phrase {
  font-style: italic; font-size: 0.95rem;
  color: var(--ink-light); margin-top: 1.2rem;
  min-height: 1.4rem; transition: opacity 0.35s;
}
.ld-dots { display: flex; gap: 5px; margin-top: 0.6rem; justify-content: center; }
.ld-dots span {
  width: 6px; height: 6px; border-radius: 50%;
  background: var(--mod); animation: dot 1.2s ease infinite;
}
.ld-dots span:nth-child(2) { animation-delay: 0.2s; }
.ld-dots span:nth-child(3) { animation-delay: 0.4s; }

/* Results */
.results { display: none; margin-top: 1.3rem; }
.results.on { display: block; animation: fadeUp 0.4s ease; }

.res-card {
  background: white; border-radius: var(--radius);
  box-shadow: var(--shadow); overflow: hidden;
  margin-bottom: 0.9rem;
}
.res-head {
  padding: 0.8rem 1.1rem;
  display: flex; align-items: center; justify-content: space-between;
  border-bottom: 1px solid var(--line);
}
.res-label {
  font-size: 0.72rem; letter-spacing: 0.06em;
  text-transform: uppercase; color: var(--ink-light);
  display: flex; align-items: center; gap: 0.35rem;
}
.res-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--mod); }
.res-body {
  padding: 1.1rem; font-size: 0.92rem;
  line-height: 1.75; color: var(--ink);
  white-space: pre-wrap; word-break: break-word;
}
.btn-copy {
  background: none; border: none; cursor: pointer;
  color: var(--ink-faint); padding: 4px; border-radius: 6px;
  font-size: 0.85rem; display: flex;
  transition: color 0.15s, background 0.15s;
}
.btn-copy:hover { color: var(--ink); background: var(--line); }

/* Version toggle (Simplificar) */
.vtoggle {
  display: flex; background: var(--line);
  border-radius: 10px; padding: 3px; gap: 2px; margin-bottom: 0.9rem;
}
.vbtn {
  flex: 1; background: none; border: none; cursor: pointer;
  padding: 0.5rem; border-radius: 8px;
  font-family: Georgia, serif; font-size: 0.85rem;
  color: var(--ink-light); transition: all 0.18s;
}
.vbtn.on { background: white; color: var(--mod); box-shadow: 0 1px 4px rgba(0,0,0,0.1); }

/* Burocracia 3 cols */
.buro-cols {
  display: grid; grid-template-columns: 1fr 1fr 1fr;
  gap: 1px; background: var(--line);
  border-radius: var(--radius); overflow: hidden; margin-bottom: 0.9rem;
}
@media (max-width: 420px) { .buro-cols { grid-template-columns: 1fr; } }
.bcol { background: white; padding: 0.9rem; }
.bcol-t {
  font-size: 0.68rem; letter-spacing: 0.07em;
  text-transform: uppercase; color: var(--mod);
  margin-bottom: 0.5rem;
}
.bcol-b { font-size: 0.82rem; line-height: 1.65; color: var(--ink); white-space: pre-wrap; }

.rd-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.7rem; margin-bottom: 0.9rem; }
@media (max-width: 380px) { .rd-grid { grid-template-columns: 1fr; } }
.rd-card { background: white; border-radius: var(--radius); padding: 0.9rem; box-shadow: var(--shadow); }
.rd-card.r { border-top: 3px solid var(--green); }
.rd-card.d { border-top: 3px solid var(--orange); }
.rd-t { font-size: 0.68rem; letter-spacing: 0.07em; text-transform: uppercase; margin-bottom: 0.45rem; }
.rd-card.r .rd-t { color: var(--green); }
.rd-card.d .rd-t { color: var(--orange); }
.rd-b { font-size: 0.8rem; line-height: 1.6; color: var(--ink); white-space: pre-wrap; }

/* Save */
.btn-save {
  display: flex; align-items: center; gap: 0.4rem;
  background: none; border: 1.5px solid var(--line);
  border-radius: 10px; padding: 0.5rem 0.9rem;
  font-family: Georgia, serif; font-size: 0.8rem;
  color: var(--ink-light); cursor: pointer;
  transition: all 0.18s; margin: 0.5rem auto 0;
  width: fit-content;
}
.btn-save:hover { border-color: var(--mod); color: var(--mod); }

/* â”€â”€ Animations â”€â”€ */
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(18px); }
  to   { opacity: 1; transform: translateY(0); }
}
</style>
</head>
<body>

<canvas id="wc"></canvas>

<!-- â•â• SPLASH â•â• -->
<div id="splash" class="screen">
  <div class="bubble-wrap" style="margin:auto;text-align:center;padding:2rem;">
    <div class="bubble" id="sb"></div>
    <div class="pen pen-lg" id="sp" onclick="penClick('sp','sb')">
      <svg viewBox="0 0 100 100" fill="none"><g id="spb">
        <rect x="43" y="8" width="14" height="26" rx="4" fill="#1a1714" opacity=".14"/>
        <rect x="46" y="6" width="8" height="4" rx="2" fill="#1a1714" opacity=".28"/>
        <rect x="38" y="18" width="24" height="50" rx="6" fill="#2563eb"/>
        <rect x="38" y="18" width="12" height="50" rx="6" fill="rgba(255,255,255,.15)"/>
        <rect x="38" y="58" width="24" height="12" rx="3" fill="#1d4ed8"/>
        <polygon points="50,95 42,68 58,68" fill="#94a3b8"/>
        <polygon points="50,95 46,68 50,72" fill="#64748b"/>
        <rect x="38" y="66" width="24" height="4" rx="1" fill="#fbbf24"/>
        <rect x="42" y="22" width="4" height="20" rx="2" fill="white" opacity=".22"/>
      </g></svg>
    </div>
    <div class="splash-logo">Lumen</div>
    <div class="splash-sub">tu asistente de texto</div>
    <div class="splash-phrase" id="sph">Preparando <span class="dots"><span>.</span><span>.</span><span>.</span></span></div>
  </div>
</div>

<!-- â•â• HOME â•â• -->
<div id="home" class="screen hidden">
  <div class="home-head">
    <div class="bubble-wrap">
      <div class="bubble" id="hb"></div>
      <div class="pen pen-lg" id="hp" onclick="penClick('hp','hb')">
        <svg viewBox="0 0 100 100" fill="none"><g id="hpb">
          <rect x="43" y="8" width="14" height="26" rx="4" fill="#1a1714" opacity=".14"/>
          <rect x="46" y="6" width="8" height="4" rx="2" fill="#1a1714" opacity=".28"/>
          <rect x="38" y="18" width="24" height="50" rx="6" fill="#2563eb"/>
          <rect x="38" y="18" width="12" height="50" rx="6" fill="rgba(255,255,255,.15)"/>
          <rect x="38" y="58" width="24" height="12" rx="3" fill="#1d4ed8"/>
          <polygon points="50,95 42,68 58,68" fill="#94a3b8"/>
          <polygon points="50,95 46,68 50,72" fill="#64748b"/>
          <rect x="38" y="66" width="24" height="4" rx="1" fill="#fbbf24"/>
          <rect x="42" y="22" width="4" height="20" rx="2" fill="white" opacity=".22"/>
        </g></svg>
      </div>
    </div>
    <div class="home-logo">Lumen</div>
    <div class="home-tag">Â¿QuÃ© quieres entender hoy?</div>
  </div>

  <div class="grid">
    <div class="card" data-m="simplificar" onclick="openMod('simplificar')">
      <div class="card-icon">ğŸ“–</div>
      <div class="card-name">Simplificar</div>
      <div class="card-desc">Textos difÃ­ciles en palabras claras</div>
    </div>
    <div class="card" data-m="burocracia" onclick="openMod('burocracia')">
      <div class="card-icon">ğŸ›ï¸</div>
      <div class="card-name">Burocracia</div>
      <div class="card-desc">Entiende lo que te piden</div>
    </div>
    <div class="card" data-m="apuntes" onclick="openMod('apuntes')">
      <div class="card-icon">ğŸ™ï¸</div>
      <div class="card-name">Apuntes</div>
      <div class="card-desc">Graba, transcribe y resume</div>
    </div>
    <div class="card" data-m="revision" onclick="openMod('revision')">
      <div class="card-icon">âœ‰ï¸</div>
      <div class="card-name">RevisiÃ³n</div>
      <div class="card-desc">Mejora lo que escribes</div>
    </div>
  </div>
</div>

<!-- â•â• MODULE â•â• -->
<div id="mod" class="screen hidden">
  <div class="mod-head">
    <button class="btn-back" onclick="goHome()" title="Volver">&#8592;</button>
    <div class="mod-title-wrap">
      <div class="mod-title" id="mt">MÃ³dulo</div>
      <div class="mod-sub" id="ms"></div>
    </div>
    <div class="pen-sm-wrap bubble-wrap">
      <div class="bubble" id="mb"></div>
      <div class="pen pen-sm" id="mp" onclick="penClick('mp','mb')">
        <svg viewBox="0 0 100 100" fill="none"><g id="mpb">
          <rect x="43" y="8" width="14" height="26" rx="4" fill="#1a1714" opacity=".14"/>
          <rect x="46" y="6" width="8" height="4" rx="2" fill="#1a1714" opacity=".28"/>
          <rect x="38" y="18" width="24" height="50" rx="6" id="pc" fill="#2563eb"/>
          <rect x="38" y="18" width="12" height="50" rx="6" fill="rgba(255,255,255,.15)"/>
          <rect x="38" y="58" width="24" height="12" rx="3" id="pcd" fill="#1d4ed8"/>
          <polygon points="50,95 42,68 58,68" fill="#94a3b8"/>
          <polygon points="50,95 46,68 50,72" fill="#64748b"/>
          <rect x="38" y="66" width="24" height="4" rx="1" fill="#fbbf24"/>
          <rect x="42" y="22" width="4" height="20" rx="2" fill="white" opacity=".22"/>
        </g></svg>
      </div>
    </div>
  </div>

  <div class="mod-body">

    <!-- INPUT TABS -->
    <div class="tabs">
      <button class="tab on" data-t="scan" onclick="switchTab('scan')">
        <span class="ti">ğŸ“·</span>Escanear
      </button>
      <button class="tab" data-t="file" onclick="switchTab('file')">
        <span class="ti">ğŸ“</span>Archivo
      </button>
      <button class="tab" data-t="text" onclick="switchTab('text')">
        <span class="ti">âœï¸</span>Texto
      </button>
      <button class="tab" data-t="audio" onclick="switchTab('audio')">
        <span class="ti">ğŸ™ï¸</span>Audio
      </button>
    </div>

    <!-- SCAN -->
    <div class="panel on" id="p-scan">
      <div class="drop" id="dz-scan"
           onclick="document.getElementById('fi-scan').click()"
           ondragover="dov(event)" ondragleave="dlv(event)" ondrop="ddrop(event,'scan')">
        <input type="file" id="fi-scan" accept="image/*" capture="environment" onchange="fsel(event,'scan')">
        <div class="drop-icon">ğŸ”</div>
        <p>Toca para abrir la cÃ¡mara</p>
        <small>o arrastra una imagen</small>
      </div>
      <div class="chip" id="ch-scan" style="display:none">
        ğŸ“· <span id="fn-scan"></span>
        <button onclick="clearF('scan')">âœ•</button>
      </div>
    </div>

    <!-- FILE -->
    <div class="panel" id="p-file">
      <div class="drop" id="dz-file"
           onclick="document.getElementById('fi-file').click()"
           ondragover="dov(event)" ondragleave="dlv(event)" ondrop="ddrop(event,'file')">
        <input type="file" id="fi-file" accept=".pdf,.doc,.docx,.txt,image/*" onchange="fsel(event,'file')">
        <div class="drop-icon">ğŸ“„</div>
        <p>Arrastra o toca para subir</p>
        <small>PDF, imagen, Word, texto</small>
      </div>
      <div class="chip" id="ch-file" style="display:none">
        ğŸ“„ <span id="fn-file"></span>
        <button onclick="clearF('file')">âœ•</button>
      </div>
    </div>

    <!-- TEXT -->
    <div class="panel" id="p-text">
      <textarea class="lta" id="ta" placeholder="Escribe o pega tu texto aquÃ­â€¦" rows="6"></textarea>
    </div>

    <!-- AUDIO -->
    <div class="panel" id="p-audio">
      <div class="audio-box">
        <button class="rec-btn" id="rb" onclick="toggleRec()">ğŸ™ï¸</button>
        <div class="rec-timer" id="rt">0:00</div>
        <div class="rec-lbl" id="rl">Toca para grabar</div>
        <div class="audio-prev" id="ap">
          <audio controls id="apl"></audio>
        </div>
      </div>
      <div class="audio-file-drop">
        <div class="drop" onclick="document.getElementById('fi-audio').click()" style="padding:1.1rem">
          <input type="file" id="fi-audio" accept="audio/*,video/*" onchange="asel(event)">
          <div class="drop-icon" style="font-size:1.4rem">ğŸµ</div>
          <p style="font-size:0.78rem">O sube un archivo de audio</p>
        </div>
        <div class="chip" id="ch-audio" style="display:none">
          ğŸµ <span id="fn-audio"></span>
          <button onclick="clearAudio()">âœ•</button>
        </div>
      </div>
    </div>

    <!-- MODULE EXTRAS -->
    <div id="mx"></div>

    <!-- SUBMIT -->
    <button class="btn-go" id="bg" onclick="submit()">
      <span id="bi">âœ¨</span> <span id="bl">Analizar</span>
    </button>

    <!-- ERROR -->
    <div class="err" id="er"></div>

    <!-- LOADING -->
    <div class="loading" id="ld">
      <div class="ld-pen">
        <svg width="64" height="64" viewBox="0 0 100 100" fill="none">
          <rect x="43" y="8" width="14" height="26" rx="4" fill="#1a1714" opacity=".14"/>
          <rect x="46" y="6" width="8" height="4" rx="2" fill="#1a1714" opacity=".28"/>
          <rect x="38" y="18" width="24" height="50" rx="6" id="lpc" fill="#2563eb"/>
          <rect x="38" y="18" width="12" height="50" rx="6" fill="rgba(255,255,255,.15)"/>
          <rect x="38" y="58" width="24" height="12" rx="3" fill="rgba(0,0,0,.12)"/>
          <polygon points="50,95 42,68 58,68" fill="#94a3b8"/>
          <polygon points="50,95 46,68 50,72" fill="#64748b"/>
          <rect x="38" y="66" width="24" height="4" rx="1" fill="#fbbf24"/>
          <rect x="42" y="22" width="4" height="20" rx="2" fill="white" opacity=".22"/>
        </svg>
      </div>
      <div class="ld-phrase" id="lp">Procesandoâ€¦</div>
      <div class="ld-dots"><span></span><span></span><span></span></div>
    </div>

    <!-- RESULTS -->
    <div class="results" id="res"></div>

  </div>
</div>

<!-- â•â• SCRIPT â•â• -->
<script>
const API = 'https://lumen-backend-674628598121.europe-west1.run.app';

const MODS = {
  simplificar: {
    title: 'Simplificar',
    sub: 'Adapta textos difÃ­ciles a lenguaje claro',
    color: '#2563eb', dark: '#1d4ed8', bg: '#eff6ff',
    label: 'Simplificar',
    endpoint: '/traduceme',
    phrases: ['Leyendo el textoâ€¦','Buscando palabras mÃ¡s clarasâ€¦','Eliminando tecnicismosâ€¦','Casi listoâ€¦'],
  },
  burocracia: {
    title: 'Burocracia',
    sub: 'Entiende documentos oficiales',
    color: '#16a34a', dark: '#15803d', bg: '#f0fdf4',
    label: 'Analizar documento',
    endpoint: '/burocracia',
    phrases: ['Descifrando el lenguaje oficialâ€¦','Identificando tus derechosâ€¦','Organizando la informaciÃ³nâ€¦','Casi listoâ€¦'],
  },
  apuntes: {
    title: 'Apuntes',
    sub: 'Transcribe y resume',
    color: '#ea580c', dark: '#c2410c', bg: '#fff7ed',
    label: 'Transcribir y resumir',
    endpoint: '/apuntes',
    phrases: ['Escuchando el audioâ€¦','Transcribiendo con Whisperâ€¦','Identificando puntos claveâ€¦','Casi listoâ€¦'],
  },
  revision: {
    title: 'RevisiÃ³n',
    sub: 'Mejora lo que escribes',
    color: '#7c3aed', dark: '#6d28d9', bg: '#f5f3ff',
    label: 'Revisar y mejorar',
    endpoint: '/revision',
    phrases: ['Leyendo tu textoâ€¦','Ajustando el tonoâ€¦','Buscando la versiÃ³n perfectaâ€¦','Casi listoâ€¦'],
  },
};

const PHRASES = ['Â¡AquÃ­ estoy!','A tu servicio.','Â¿Necesitas algo?','Â¡Vamos!','Soy todo oÃ­dos.','Listo para escribir.'];
const SPLASH_PH = ['Preparando la tintaâ€¦','Afilando la puntaâ€¦','Cargando palabrasâ€¦','Casi listoâ€¦'];

let curMod = null, curTab = 'scan';
let scanF = null, docF = null, audBlob = null, audFile = null;
let mr = null, recChunks = [], recSec = 0, recInt = null, isRec = false;
let simpResult = null;
let ctxSel = 'Trabajo';

// â”€â”€ INIT â”€â”€
window.addEventListener('load', () => {
  startCanvas();
  splashGo();
  fetch(API + '/').catch(() => {});
});

// â”€â”€ SPLASH â”€â”€
function splashGo() {
  let i = 0;
  const el = document.getElementById('sph');
  const cycle = setInterval(() => {
    i++;
    if (i >= SPLASH_PH.length) { clearInterval(cycle); return; }
    el.style.opacity = 0;
    setTimeout(() => { el.innerHTML = SPLASH_PH[i]; el.style.opacity = 1; }, 280);
  }, 900);
  setTimeout(toHome, 3000);
}
function toHome() {
  const s = document.getElementById('splash');
  s.style.transition = 'opacity 0.45s';
  s.style.opacity = 0;
  setTimeout(() => show('home'), 450);
}

// â”€â”€ SCREEN TRANSITIONS â”€â”€
function show(id) {
  document.querySelectorAll('.screen').forEach(s => {
    s.classList.add('hidden');
  });
  const el = document.getElementById(id);
  el.classList.remove('hidden', 'slide-back');
  el.scrollTop = 0;
}

function goHome() {
  resetMod();
  show('home');
}

// â”€â”€ OPEN MODULE â”€â”€
function openMod(id) {
  curMod = id;
  const c = MODS[id];
  const r = document.documentElement;
  r.style.setProperty('--mod', c.color);
  r.style.setProperty('--mod-bg', c.bg);
  document.getElementById('pc').setAttribute('fill', c.color);
  document.getElementById('pcd').setAttribute('fill', c.dark);
  document.getElementById('lpc').setAttribute('fill', c.color);
  document.getElementById('mt').textContent = c.title;
  document.getElementById('ms').textContent = c.sub;
  document.getElementById('bl').textContent = c.label;
  switchTab('scan');
  renderExtras(id);
  clearResults();
  show('mod');
}

// â”€â”€ EXTRAS â”€â”€
function renderExtras(id) {
  const el = document.getElementById('mx');
  if (id === 'revision') {
    el.innerHTML = `
      <div style="margin-bottom:1rem">
        <label class="field-lbl">Contexto del mensaje</label>
        <div class="ctx-grid">
          ${[['Trabajo','ğŸ’¼'],['Pareja','ğŸ’›'],['Familia','ğŸ '],['Legal','âš–ï¸']].map(([l,ic]) =>
            `<button class="ctx-btn${l===ctxSel?' on':''}" onclick="setSel('${l}',this)">${ic} ${l}</button>`
          ).join('')}
        </div>
      </div>`;
  } else {
    el.innerHTML = '';
  }
}

function setSel(v, btn) {
  ctxSel = v;
  btn.closest('.ctx-grid').querySelectorAll('.ctx-btn').forEach(b => b.classList.remove('on'));
  btn.classList.add('on');
}

// â”€â”€ TABS â”€â”€
function switchTab(t) {
  curTab = t;
  document.querySelectorAll('.tab').forEach(b => b.classList.toggle('on', b.dataset.t === t));
  document.querySelectorAll('.panel').forEach(p => p.classList.toggle('on', p.id === 'p-'+t));
}

// â”€â”€ FILE HANDLING â”€â”€
function fsel(e, type) {
  const f = e.target.files[0]; if (!f) return;
  if (type === 'scan') { scanF = f; document.getElementById('fn-scan').textContent = f.name; document.getElementById('ch-scan').style.display='inline-flex'; }
  else { docF = f; document.getElementById('fn-file').textContent = f.name; document.getElementById('ch-file').style.display='inline-flex'; }
}
function clearF(type) {
  if (type === 'scan') { scanF = null; document.getElementById('fi-scan').value=''; document.getElementById('ch-scan').style.display='none'; }
  else { docF = null; document.getElementById('fi-file').value=''; document.getElementById('ch-file').style.display='none'; }
}
function dov(e) { e.preventDefault(); e.currentTarget.classList.add('over'); }
function dlv(e) { e.currentTarget.classList.remove('over'); }
function ddrop(e, type) {
  e.preventDefault(); e.currentTarget.classList.remove('over');
  const f = e.dataTransfer.files[0]; if (!f) return;
  fsel({ target: { files: [f] } }, type);
}

// â”€â”€ AUDIO â”€â”€
async function toggleRec() {
  if (!isRec) {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mr = new MediaRecorder(stream);
      recChunks = [];
      mr.ondataavailable = e => recChunks.push(e.data);
      mr.onstop = () => {
        audBlob = new Blob(recChunks, { type: 'audio/webm' });
        const url = URL.createObjectURL(audBlob);
        document.getElementById('apl').src = url;
        document.getElementById('ap').style.display = 'block';
        stream.getTracks().forEach(t => t.stop());
      };
      mr.start(); isRec = true; recSec = 0;
      document.getElementById('rb').classList.add('on');
      document.getElementById('rb').textContent = 'â¹ï¸';
      document.getElementById('rl').textContent = 'Grabandoâ€¦ toca para detener';
      document.getElementById('rt').style.display = 'block';
      recInt = setInterval(() => {
        recSec++;
        const m = Math.floor(recSec/60), s = recSec%60;
        document.getElementById('rt').textContent = `${m}:${s.toString().padStart(2,'0')}`;
      }, 1000);
    } catch(e) { showErr('No se pudo acceder al micrÃ³fono.'); }
  } else {
    mr.stop(); isRec = false; clearInterval(recInt);
    document.getElementById('rb').classList.remove('on');
    document.getElementById('rb').textContent = 'ğŸ™ï¸';
    document.getElementById('rl').textContent = 'GrabaciÃ³n guardada. Toca para grabar de nuevo.';
    document.getElementById('rt').style.display = 'none';
  }
}
function asel(e) {
  audFile = e.target.files[0]; if (!audFile) return;
  document.getElementById('fn-audio').textContent = audFile.name;
  document.getElementById('ch-audio').style.display = 'inline-flex';
}
function clearAudio() {
  audFile = null;
  document.getElementById('fi-audio').value = '';
  document.getElementById('ch-audio').style.display = 'none';
}

// â”€â”€ SUBMIT â”€â”€
async function submit() {
  hideErr();
  const c = MODS[curMod];
  // For text tab: send JSON. For file/scan/audio: send FormData.
  let isJson = false;
  let fd = new FormData();
  let jsonBody = null;
  let ok = false;

  if (curTab === 'text') {
    const t = document.getElementById('ta').value.trim();
    if (!t) { showErr('Escribe o pega texto antes de continuar.'); return; }
    isJson = true;
    jsonBody = { text: t };
    if (curMod === 'revision') jsonBody.contexto = ctxSel;
    ok = true;
  } else if (curTab === 'scan') {
    if (!scanF) { showErr('Selecciona o escanea una imagen.'); return; }
    fd.append('image', scanF); ok = true;
  } else if (curTab === 'file') {
    if (!docF) { showErr('Selecciona un archivo.'); return; }
    fd.append('file', docF); ok = true;
  } else if (curTab === 'audio') {
    const blob = audFile || audBlob;
    if (!blob) { showErr('Graba o sube un audio primero.'); return; }
    fd.append('audio', blob instanceof File ? blob : new File([blob], 'rec.webm', { type: 'audio/webm' }));
    ok = true;
  }
  if (!ok) return;

  if (!isJson && curMod === 'revision') fd.append('contexto', ctxSel);

  showLoad();
  let pi = 0;
  const pit = setInterval(() => {
    pi = (pi+1) % c.phrases.length;
    const lp = document.getElementById('lp');
    lp.style.opacity = 0;
    setTimeout(() => { lp.textContent = c.phrases[pi]; lp.style.opacity = 1; }, 280);
  }, 2000);

  try {
    // Step 1: if image/file â†’ extract text via /scan
    if (curTab === 'scan' || curTab === 'file') {
      const sr = await fetch(API + '/scan', { method: 'POST', body: fd });
      if (!sr.ok) throw new Error('Error al procesar imagen (' + sr.status + ')');
      const sd = await sr.json();
      const txt = sd.text || '';
      if (!txt) throw new Error('No se pudo extraer texto de la imagen.');
      fd = new FormData();
      fd.append('text', txt);
      if (curMod === 'revision') fd.append('contexto', ctxSel);
    }

    // Step 2: if audio â†’ transcribe first, then send text to module endpoint
    if (curTab === 'audio') {
      const tr = await fetch(API + '/transcribe', { method: 'POST', body: fd });
      if (!tr.ok) throw new Error('Error al transcribir audio (' + tr.status + ')');
      const td = await tr.json();
      const txt = td.text || '';
      if (!txt) throw new Error('No se pudo transcribir el audio.');
      fd = new FormData();
      fd.append('text', txt);
      if (curMod === 'revision') fd.append('contexto', ctxSel);
    }

    // After scan/audio processing, text is in fd as FormData â†’ convert to JSON
    if (!isJson && (curTab === 'scan' || curTab === 'file' || curTab === 'audio')) {
      const extractedText = fd.get('text');
      if (extractedText) {
        isJson = true;
        jsonBody = { text: extractedText };
        if (curMod === 'revision') jsonBody.contexto = ctxSel;
      }
    }

    const fetchOpts = isJson
      ? { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(jsonBody) }
      : { method: 'POST', body: fd };

    const r = await fetch(API + c.endpoint, fetchOpts);
    clearInterval(pit);
    if (!r.ok) throw new Error('Error del servidor ('+r.status+')');
    const data = await r.json();
    hideLoad();
    renderRes(data);
  } catch(e) {
    clearInterval(pit);
    hideLoad();
    showErr('Error: ' + e.message);
  }
}

// â”€â”€ RENDER RESULTS â”€â”€
function renderRes(data) {
  const el = document.getElementById('res');
  el.innerHTML = '';
  el.classList.remove('on');

  if (curMod === 'simplificar') {
    // Backend returns: { nino, normal, experto, conceptos }
    simpResult = { simple: data.nino || '', completa: data.normal || '' };
    el.innerHTML = `
      <div class="vtoggle">
        <button class="vbtn on" id="vsim" onclick="showV('simple')">Simple</button>
        <button class="vbtn" id="vcom" onclick="showV('completa')">Completa</button>
      </div>
      ${rcard('VersiÃ³n simplificada', simpResult.simple, 'vtext')}
      ${savebtn()}`;
  } else if (curMod === 'burocracia') {
    // Backend returns: { que_dicen, que_hago, y_si_no, derechos[], deberes[] }
    const der = Array.isArray(data.derechos) ? data.derechos.join('\n') : (data.derechos||'');
    const deb = Array.isArray(data.deberes) ? data.deberes.join('\n') : (data.deberes||'');
    el.innerHTML = `
      <div class="buro-cols">
        <div class="bcol"><div class="bcol-t">\u00bfQu\u00e9 te piden?</div><div class="bcol-b">${esc(data.que_dicen||'')}</div></div>
        <div class="bcol"><div class="bcol-t">\u00bfQu\u00e9 hago?</div><div class="bcol-b">${esc(data.que_hago||'')}</div></div>
        <div class="bcol"><div class="bcol-t">\u00bfY si no lo hago?</div><div class="bcol-b">${esc(data.y_si_no||'')}</div></div>
      </div>
      <div class="rd-grid">
        <div class="rd-card r"><div class="rd-t">Tus derechos</div><div class="rd-b">${esc(der)}</div></div>
        <div class="rd-card d"><div class="rd-t">Tus obligaciones</div><div class="rd-b">${esc(deb)}</div></div>
      </div>
      ${savebtn()}`;
  } else if (curMod === 'apuntes') {
    // Backend returns: { resumen, puntos_clave[], accionables[], sin_resolver[] }
    const pk = Array.isArray(data.puntos_clave) ? data.puntos_clave.map((p,i)=>`${i+1}. ${p}`).join('\n') : (data.puntos_clave||'');
    const ac = Array.isArray(data.accionables) ? data.accionables.map(a=>typeof a==='object'?(a.tarea+(a.responsable?` (${a.responsable})`:'')):a).join('\n') : '';
    const sr = Array.isArray(data.sin_resolver) ? data.sin_resolver.join('\n') : (data.sin_resolver||'');
    el.innerHTML = `
      ${rcard('Resumen', data.resumen||'', 'asum')}
      ${pk ? rcard('Puntos clave', pk, 'apk') : ''}
      ${ac ? rcard('Accionables', ac, 'aac') : ''}
      ${sr ? rcard('Temas sin resolver', sr, 'asr') : ''}
      ${savebtn()}`;
  } else if (curMod === 'revision') {
    // Backend returns: { problemas[], version_mejorada, tono_general, score_sentimiento }
    const probs = Array.isArray(data.problemas) && data.problemas.length
      ? data.problemas.map(p=>`\u2022 ${p.frase}: ${p.explicacion}`).join('\n') : '';
    el.innerHTML = `
      ${rcard('Texto mejorado', data.version_mejorada||'', 'rtx')}
      ${probs ? rcard('Observaciones', probs, 'robs') : ''}
      ${savebtn()}`;
  }

  el.classList.add('on');
  setTimeout(() => el.scrollIntoView({ behavior: 'smooth', block: 'start' }), 50);
}

function rcard(title, text, id) {
  return `<div class="res-card">
    <div class="res-head">
      <div class="res-label"><div class="res-dot"></div>${title}</div>
      <button class="btn-copy" onclick="cp('${id}')" title="Copiar">ğŸ“‹</button>
    </div>
    <div class="res-body" id="${id}">${esc(text)}</div>
  </div>`;
}

function savebtn() {
  return `<button class="btn-save" onclick="saveImg()">â¬‡ Guardar imagen</button>`;
}

function showV(v) {
  const el = document.getElementById('vtext');
  if (!el || !simpResult) return;
  el.innerHTML = esc(v==='simple' ? (simpResult.simple||simpResult.result||'') : (simpResult.completa||simpResult.complete||simpResult.result||''));
  document.getElementById('vsim').classList.toggle('on', v==='simple');
  document.getElementById('vcom').classList.toggle('on', v==='completa');
}

// â”€â”€ UTILS â”€â”€
function esc(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
}
function cp(id) {
  const el = document.getElementById(id); if (!el) return;
  navigator.clipboard.writeText(el.innerText||el.textContent).catch(()=>{});
}
async function saveImg() {
  if (typeof html2canvas === 'undefined') { showErr('html2canvas no disponible.'); return; }
  try {
    const c = await html2canvas(document.getElementById('res'), { backgroundColor: '#faf8f4', scale: 2 });
    const a = document.createElement('a');
    a.download = `lumen-${curMod}-${Date.now()}.png`;
    a.href = c.toDataURL('image/png'); a.click();
  } catch(e) { showErr('No se pudo guardar.'); }
}

function showLoad() {
  document.getElementById('bg').disabled = true;
  const c = MODS[curMod];
  document.getElementById('lp').textContent = c.phrases[0];
  document.getElementById('ld').classList.add('on');
  document.getElementById('res').classList.remove('on');
}
function hideLoad() {
  document.getElementById('bg').disabled = false;
  document.getElementById('ld').classList.remove('on');
}
function showErr(msg) {
  const el = document.getElementById('er'); el.textContent = msg; el.classList.add('on');
}
function hideErr() { document.getElementById('er').classList.remove('on'); }
function clearResults() {
  hideErr(); hideLoad();
  const r = document.getElementById('res'); r.innerHTML = ''; r.classList.remove('on');
}
function resetMod() {
  scanF = null; docF = null; audBlob = null; audFile = null;
  if (isRec) { try { mr.stop(); } catch(e){} isRec = false; }
  clearInterval(recInt); simpResult = null;
}

// â”€â”€ PEN CLICK â”€â”€
function penClick(penId, bubId) {
  const phrase = PHRASES[Math.floor(Math.random()*PHRASES.length)];
  const b = document.getElementById(bubId);
  b.textContent = phrase; b.classList.add('show');
  clearTimeout(b._t); b._t = setTimeout(() => b.classList.remove('show'), 2500);
  const pen = document.getElementById(penId);
  pen.style.transition = 'transform 0.1s'; pen.style.transform = 'rotate(-10deg) scale(1.08)';
  setTimeout(() => { pen.style.transform = ''; }, 350);
  if (navigator.vibrate) navigator.vibrate(25);
}

// â”€â”€ WORD CANVAS â”€â”€
const WPOOL = {
  default: ['texto','palabra','frase','nota','ideas','lumen','escribe','lee','piensa','entiende','claridad','boli'],
  simplificar: ['simple','claro','fÃ¡cil','entender','adaptar','vocabulario','lenguaje','sentido','bÃ¡sico','comprensible'],
  burocracia: ['artÃ­culo','decreto','resoluciÃ³n','notificaciÃ³n','plazo','derecho','deber','trÃ¡mite','expediente','cÃ³digo'],
  apuntes: ['reuniÃ³n','idea','tarea','resumen','clave','notas','audio','voz','acciÃ³n','punto','grabar'],
  revision: ['tono','estilo','claridad','mensaje','carta','email','mejorar','pulir','registro','redactar'],
};

let ws = [];
function startCanvas() {
  const cv = document.getElementById('wc');
  const cx = cv.getContext('2d');
  function rs() { cv.width = innerWidth; cv.height = innerHeight; }
  rs(); addEventListener('resize', rs);

  function pool() { return WPOOL[curMod] || WPOOL.default; }
  function spawn() {
    const p = pool(), w = p[Math.floor(Math.random()*p.length)];
    ws.push({ t: w, x: 60+Math.random()*(cv.width-80), y: 20+Math.random()*(cv.height-30),
      sz: 10+Math.random()*9, a: 0, ph: 'in', life: 0, max: 160+Math.random()*120 });
  }
  setInterval(spawn, 900);
  function tick() {
    cx.clearRect(0,0,cv.width,cv.height);
    ws = ws.filter(w => w.ph !== 'dead');
    for (const w of ws) {
      w.life++;
      if (w.ph==='in')   { w.a = Math.min(1, w.life/28); if (w.a>=1) w.ph='hold'; }
      else if (w.ph==='hold') { if (w.life>=w.max) w.ph='out'; }
      else if (w.ph==='out')  { w.a -= 0.022; if (w.a<=0) w.ph='dead'; }
      cx.save(); cx.globalAlpha=w.a;
      cx.font=`italic ${w.sz}px Georgia,serif`;
      cx.fillStyle='#1a1714'; cx.fillText(w.t,w.x,w.y);
      cx.restore();
    }
    if (ws.length < 16) spawn();
    requestAnimationFrame(tick);
  }
  tick();
}
</script>

<!-- html2canvas lazy loaded -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/lumen-frontend/service-worker.js')
      .then(() => console.log('Lumen SW registered'))
      .catch(e => console.log('SW error:', e));
  });
}
</script>
</body>
</html>
